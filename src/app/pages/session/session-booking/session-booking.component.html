<!-- src/app/pages/session/session-booking/session-booking.component.html -->
<div class="container mx-auto px-4 py-8">
    <p-toast></p-toast>

    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold text-gray-800">{{ 'Session Booking' | translate }}</h1>
        <p-button icon="pi pi-plus" label="{{ 'Book New Session' | translate }}" (click)="showBookingDialog = true" styleClass="p-button-success"></p-button>
    </div>

    <!-- Session History Table -->
    <p-table [value]="sessions" [paginator]="true" [rows]="10" [showCurrentPageReport]="true" currentPageReportTemplate="Showing {first} to {last} of {totalRecords} sessions" styleClass="p-datatable-striped" [loading]="loading">
        <ng-template pTemplate="header">
            <tr>
                <th class="text-left">{{ 'common.labels.date' | translate }}</th>
                <th class="text-left">{{ 'common.labels.time' | translate }}</th>
                <th class="text-left">{{ 'common.labels.specialist' | translate }}</th>
                <th class="text-left">{{ 'common.labels.status' | translate }}</th>
                <th class="text-left">{{ 'common.labels.notes' | translate }}</th>
                <th class="text-center">{{ 'common.labels.actions' | translate }}</th>
            </tr>
        </ng-template>

        <ng-template pTemplate="loadingbody">
            <tr *ngFor="let _ of [1, 2, 3, 4, 5]">
                <td><p-skeleton></p-skeleton></td>
                <td><p-skeleton></p-skeleton></td>
                <td><p-skeleton></p-skeleton></td>
                <td><p-skeleton></p-skeleton></td>
                <td><p-skeleton></p-skeleton></td>
                <td class="text-center">
                    <p-skeleton width="2rem" height="2rem" shape="circle" styleClass="mr-2"></p-skeleton>
                    <p-skeleton width="2rem" height="2rem" shape="circle"></p-skeleton>
                </td>
            </tr>
        </ng-template>

        <ng-template pTemplate="body" let-session>
            <tr>
                <td>
                    <span *ngIf="session.timeSlot">
                        {{ session.timeSlot.startTime | date: 'EEEE, MMMM d, y' }}
                    </span>
                    <span *ngIf="!session.timeSlot">No time slot data</span>
                </td>
                <td>
                    <span *ngIf="session.timeSlot">
                        {{ session.timeSlot.startTime | date: 'shortTime' }} -
                        {{ session.timeSlot.endTime | date: 'shortTime' }}
                    </span>
                    <span *ngIf="!session.timeSlot">No time slot data</span>
                </td>
                <td>
                    <span *ngIf="session.assignedSpecialistName">
                        {{ session.assignedSpecialistName }}
                    </span>
                    <span *ngIf="!session.assignedSpecialistName">Auto-assigned</span>
                </td>
                <td>
                    <span
                        [ngClass]="{
                            'text-green-600': session.status === 'confirmed',
                            'text-red-600': session.status === 'cancelled',
                            'text-yellow-600': session.status === 'pending',
                            'text-blue-600': session.status === 'completed'
                        }"
                    >
                        {{ session.status | titlecase }}
                    </span>
                </td>
                <td>{{ session.notes || '-' }}</td>
                <td class="text-center">
                    <div class="flex justify-center gap-2">
                        <button pButton pRipple icon="pi pi-eye" class="p-button-rounded p-button-text p-button-info" (click)="viewSessionDetails(session)" pTooltip="View Details" tooltipPosition="top"></button>

                        <button
                            *ngIf="session.zoomMeeting && (isSessionUpcoming(session) || isSessionInProgress(session))"
                            pButton
                            pRipple
                            icon="pi pi-video"
                            class="p-button-rounded p-button-text p-button-success"
                            (click)="joinZoomMeeting(session)"
                            pTooltip="Join Zoom Meeting"
                            tooltipPosition="top"
                        ></button>

                        <button
                            *ngIf="canModifySession(session)"
                            pButton
                            pRipple
                            icon="pi pi-times"
                            class="p-button-rounded p-button-text p-button-danger"
                            (click)="confirmCancelSession(session)"
                            pTooltip="Cancel Session"
                            tooltipPosition="top"
                        ></button>
                    </div>
                </td>
            </tr>
        </ng-template>

        <ng-template pTemplate="emptymessage">
            <tr>
                <td colspan="6" class="text-center py-4">
                    <div class="flex flex-col items-center">
                        <i class="pi pi-calendar-times text-4xl text-gray-400 mb-2"></i>
                        <p class="text-gray-500">{{ 'pages.specialist.noBookings' | translate }}</p>
                    </div>
                </td>
            </tr>
        </ng-template>
    </p-table>

    <!-- Booking Dialog -->
    <p-dialog [(visible)]="showBookingDialog" [style]="{ width: '450px' }" header="{{ 'Book New Session' | translate }}" [modal]="true" styleClass="p-fluid" [draggable]="false" [resizable]="false">
        <div class="flex flex-col gap-4">
            <div class="flex flex-col gap-2">
                <label for="selectedDate" class="font-medium">{{ 'Select Date' | translate }}</label>
                <p-datepicker id="selectedDate" [(ngModel)]="selectedDate" [minDate]="minDate" [showIcon]="true" [showTime]="false" [disabledDates]="disabledDates" dateFormat="yy-mm-dd" appendTo="body" (onSelect)="onDateSelect()"> </p-datepicker>

                <div *ngIf="loadingTimeSlots" class="text-center mt-2">
                    <p-skeleton width="100%" height="40px"></p-skeleton>
                </div>
            </div>

            <div class="flex flex-col gap-2" *ngIf="!loadingTimeSlots && availableTimeSlots.length > 0">
                <label for="timeSlot" class="font-medium">{{ 'Available Time Slots' | translate }}</label>
                <p-dropdown id="timeSlot" [(ngModel)]="selectedTimeSlot" [options]="availableTimeSlots" optionLabel="displayLabel" placeholder="{{ 'Select Time Slot' | translate }}" styleClass="w-full"> </p-dropdown>
            </div>

            <div *ngIf="selectedDate && !loadingTimeSlots && availableTimeSlots.length === 0" class="bg-yellow-100 text-yellow-700 p-3 rounded">
                {{ 'No available time slots for the selected date' | translate }}
            </div>

            <div class="flex flex-col gap-2">
                <label for="notes" class="font-medium">{{ 'Notes (Optional)' | translate }}</label>
                <textarea pInputTextarea id="notes" [(ngModel)]="bookingNotes" rows="3" class="w-full"> </textarea>
            </div>

            <div class="bg-blue-50 p-3 rounded text-blue-700 text-sm">
                <i class="pi pi-info-circle mr-2"></i>
                {{ 'This will create a Zoom meeting for your session' | translate }}
            </div>
        </div>

        <ng-template pTemplate="footer">
            <p-button label="{{ 'Cancel' | translate }}" icon="pi pi-times" (click)="showBookingDialog = false" styleClass="p-button-text"> </p-button>
            <p-button label="{{ 'Book Session with Zoom' | translate }}" icon="pi pi-check" (click)="submitBookingWithZoom()" [disabled]="!selectedTimeSlot"> </p-button>
        </ng-template>
    </p-dialog>

    <!-- Session Details + Zoom Meeting Dialog -->
    <p-dialog [(visible)]="showZoomMeetingDialog" [style]="{ width: '700px' }" [header]="'Session Details' | translate" [modal]="true" styleClass="p-fluid" [draggable]="false" [resizable]="false">
        <p-tabView [(activeIndex)]="activeSessionTab">
            <p-tabPanel [header]="'Details' | translate">
                <div *ngIf="selectedSession" class="p-4">
                    <div class="grid">
                        <div class="col-12 md:col-6">
                            <h3 class="text-xl font-semibold mb-4">{{ 'Session Information' | translate }}</h3>

                            <div class="flex flex-col gap-3">
                                <div>
                                    <span class="font-semibold block">{{ 'Date' | translate }}:</span>
                                    <span>{{ selectedSession.timeSlot?.startTime | date: 'fullDate' }}</span>
                                </div>

                                <div>
                                    <span class="font-semibold block">{{ 'Time' | translate }}:</span>
                                    <span>{{ selectedSession.timeSlot?.startTime | date: 'shortTime' }} - {{ selectedSession.timeSlot?.endTime | date: 'shortTime' }}</span>
                                </div>

                                <div>
                                    <span class="font-semibold block">{{ 'Specialist' | translate }}:</span>
                                    <span>{{ selectedSession.assignedSpecialistName || 'Not assigned yet' }}</span>
                                </div>

                                <div>
                                    <span class="font-semibold block">{{ 'Status' | translate }}:</span>
                                    <span
                                        [ngClass]="{
                                            'text-green-600': selectedSession.status === 'confirmed',
                                            'text-red-600': selectedSession.status === 'cancelled',
                                            'text-yellow-600': selectedSession.status === 'pending',
                                            'text-blue-600': selectedSession.status === 'completed'
                                        }"
                                        >{{ selectedSession.status | titlecase }}</span
                                    >
                                </div>

                                <div *ngIf="selectedSession.notes">
                                    <span class="font-semibold block">{{ 'Notes' | translate }}:</span>
                                    <p class="mt-1 text-gray-600">{{ selectedSession.notes }}</p>
                                </div>
                            </div>
                        </div>

                        <div class="col-12 md:col-6" *ngIf="selectedSession.zoomMeeting">
                            <h3 class="text-xl font-semibold mb-4">{{ 'Zoom Meeting' | translate }}</h3>

                            <div class="flex flex-col gap-3">
                                <div>
                                    <span class="font-semibold block">{{ 'Meeting ID' | translate }}:</span>
                                    <span>{{ selectedSession.zoomMeeting.meetingNumber }}</span>
                                </div>

                                <div>
                                    <span class="font-semibold block">{{ 'Password' | translate }}:</span>
                                    <span>{{ selectedSession.zoomMeeting.password }}</span>
                                </div>

                                <div>
                                    <span class="font-semibold block">{{ 'Duration' | translate }}:</span>
                                    <span>{{ selectedSession.zoomMeeting.duration }} minutes</span>
                                </div>

                                <div class="mt-3">
                                    <p-button *ngIf="isSessionUpcoming(selectedSession) || isSessionInProgress(selectedSession)" icon="pi pi-video" label="Join Meeting" styleClass="p-button-success" (onClick)="activeSessionTab = 1"> </p-button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </p-tabPanel>

            <p-tabPanel [header]="'Zoom Meeting' | translate" *ngIf="selectedSession?.zoomMeeting">
                <app-zoom-meeting [meeting]="selectedSession?.zoomMeeting" [isHost]="false" (meetingJoined)="onZoomMeetingJoined()" (meetingEnded)="onZoomMeetingEnded()"> </app-zoom-meeting>
            </p-tabPanel>
        </p-tabView>

        <ng-template pTemplate="footer">
            <p-button label="{{ 'Close' | translate }}" icon="pi pi-times" (click)="showZoomMeetingDialog = false" styleClass="p-button-secondary"></p-button>
        </ng-template>
    </p-dialog>

    <!-- Cancel Confirmation Dialog -->
    <p-dialog [(visible)]="showCancelDialog" header="{{ 'Cancel Session' | translate }}" [modal]="true" [style]="{ width: '400px' }" [draggable]="false" [resizable]="false">
        <p *ngIf="sessionToCancel">
            {{ 'Are you sure you want to cancel this session on' | translate }}
            <strong>{{ sessionToCancel.timeSlot?.startTime | date: 'MMMM d, y' }}</strong>
            {{ 'at' | translate }}
            <strong>{{ sessionToCancel.timeSlot?.startTime | date: 'shortTime' }}</strong
            >?
        </p>

        <div *ngIf="sessionToCancel?.zoomMeeting" class="mt-3 p-3 bg-yellow-50 text-yellow-700 rounded">
            <i class="pi pi-exclamation-triangle mr-2"></i>
            {{ 'This will also cancel the associated Zoom meeting' | translate }}
        </div>

        <ng-template pTemplate="footer">
            <p-button label="{{ 'No' | translate }}" icon="pi pi-times" (click)="showCancelDialog = false" styleClass="p-button-text"> </p-button>
            <p-button label="{{ 'Yes' | translate }}" icon="pi pi-check" (click)="cancelSession()" styleClass="p-button-danger"> </p-button>
        </ng-template>
    </p-dialog>
</div>

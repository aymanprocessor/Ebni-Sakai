<!-- src/app/pages/specialist-bookings/specialist-bookings.component.html -->
<div class="container mx-auto px-4 py-6">
    <p-toast></p-toast>
    <p-confirmDialog></p-confirmDialog>

    <div class="mb-6">
        <div class="flex flex-col sm:flex-row justify-between gap-4 mb-4">
            <h1 class="text-2xl font-semibold text-gray-800 dark:text-white">{{ 'pages.specialist.myBookings' | translate }}</h1>
        </div>

        <div class="bg-indigo-50 dark:bg-indigo-900 p-4 rounded-lg mb-4">
            <div class="flex items-center text-indigo-800 dark:text-indigo-200">
                <i class="pi pi-info-circle mr-2"></i>
                <p>{{ 'pages.specialist.bookingsInfo' | translate }}</p>
            </div>
        </div>
    </div>

    <div *ngIf="loading" class="flex justify-center my-8">
        <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-indigo-500"></div>
    </div>

    <div *ngIf="!loading" class="card">
        <p-table [value]="bookings" [paginator]="true" [rows]="10" [showCurrentPageReport]="true" currentPageReportTemplate="Showing {first} to {last} of {totalRecords} bookings" [rowHover]="true" styleClass="p-datatable-striped" [loading]="loading">
            <ng-template pTemplate="header">
                <tr>
                    <th>{{ 'common.labels.date' | translate }}</th>
                    <th>{{ 'common.labels.time' | translate }}</th>
                    <th>{{ 'common.labels.client' | translate }}</th>
                    <th>{{ 'common.labels.email' | translate }}</th>
                    <th>{{ 'common.labels.status' | translate }}</th>
                    <th>{{ 'common.labels.notes' | translate }}</th>
                    <th>{{ 'common.labels.actions' | translate }}</th>
                </tr>
            </ng-template>

            <ng-template pTemplate="loadingbody">
                <tr *ngFor="let _ of [1, 2, 3]">
                    <td><p-skeleton></p-skeleton></td>
                    <td><p-skeleton></p-skeleton></td>
                    <td><p-skeleton></p-skeleton></td>
                    <td><p-skeleton></p-skeleton></td>
                    <td><p-skeleton></p-skeleton></td>
                    <td><p-skeleton></p-skeleton></td>
                    <td class="text-center">
                        <p-skeleton width="2rem" height="2rem" shape="circle" styleClass="mr-2"></p-skeleton>
                        <p-skeleton width="2rem" height="2rem" shape="circle"></p-skeleton>
                    </td>
                </tr>
            </ng-template>

            <ng-template pTemplate="body" let-booking>
                <tr>
                    <td>
                        <span *ngIf="booking.timeSlot">
                            {{ booking.timeSlot.startTime }}
                        </span>
                    </td>
                    <td>
                        <span *ngIf="booking.timeSlot">
                            {{ booking.timeSlot.startTime }} -
                            {{ booking.timeSlot.endTime }}
                        </span>
                    </td>
                    <td>{{ booking.userName }}</td>
                    <td>{{ booking.userEmail }}</td>
                    <td>
                        <p-tag [value]="booking.status" [severity]="getStatusSeverity(booking.status)"></p-tag>
                    </td>
                    <td>{{ booking.notes || '-' }}</td>
                    <td>
                        <div class="flex gap-2">
                            <!-- View Details Button -->
                            <button pButton pRipple icon="pi pi-eye" class="p-button-rounded p-button-text p-button-info" (click)="viewBookingDetails(booking)" pTooltip="View Details" tooltipPosition="top"></button>

                            <!-- Zoom Meeting Button -->
                            <button
                                *ngIf="booking.zoomMeeting && (isSessionUpcoming(booking) || isSessionInProgress(booking))"
                                pButton
                                pRipple
                                icon="pi pi-video"
                                class="p-button-rounded p-button-text p-button-success"
                                (click)="viewZoomMeeting(booking)"
                                pTooltip="Join Zoom Meeting"
                                tooltipPosition="top"
                            ></button>

                            <!-- Confirm Button (for pending bookings) -->
                            <button
                                *ngIf="booking.status === 'pending'"
                                pButton
                                pRipple
                                icon="pi pi-check"
                                class="p-button-rounded p-button-text p-button-success"
                                (click)="confirmBooking(booking)"
                                pTooltip="Confirm Booking"
                                tooltipPosition="top"
                            ></button>

                            <!-- Complete Button (for confirmed bookings) -->
                            <button
                                *ngIf="booking.status === 'confirmed'"
                                pButton
                                pRipple
                                icon="pi pi-check-circle"
                                class="p-button-rounded p-button-text p-button-primary"
                                (click)="completeBooking(booking)"
                                pTooltip="Mark as Completed"
                                tooltipPosition="top"
                            ></button>

                            <!-- Cancel Button (for pending or confirmed bookings) -->
                            <button
                                *ngIf="booking.status !== 'cancelled' && booking.status !== 'completed'"
                                pButton
                                pRipple
                                icon="pi pi-times"
                                class="p-button-rounded p-button-text p-button-danger"
                                (click)="cancelBooking(booking)"
                                pTooltip="Cancel Booking"
                                tooltipPosition="top"
                            ></button>
                        </div>
                    </td>
                </tr>
            </ng-template>

            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="7" class="text-center py-4">
                        <div class="flex flex-col items-center">
                            <i class="pi pi-calendar-times text-4xl text-gray-400 mb-2"></i>
                            <p class="text-gray-500">{{ 'pages.specialist.noBookings' | translate }}</p>
                        </div>
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </div>

    <!-- Booking Details + Zoom Meeting Dialog -->
    <p-dialog [(visible)]="showDetailsDialog" [style]="{ width: '700px' }" [header]="'Booking Details' | translate" [modal]="true" styleClass="p-fluid" [draggable]="false" [resizable]="false">
        <p-tabView [(activeIndex)]="activeBookingTab">
            <p-tabPanel [header]="'Details' | translate">
                <div *ngIf="selectedBooking" class="p-4">
                    <div class="grid">
                        <div class="col-12 md:col-6">
                            <h3 class="text-xl font-semibold mb-4">{{ 'Client Information' | translate }}</h3>

                            <div class="flex flex-col gap-3">
                                <div>
                                    <span class="font-semibold block">{{ 'Client Name' | translate }}:</span>
                                    <span>{{ selectedBooking.userName }}</span>
                                </div>

                                <div>
                                    <span class="font-semibold block">{{ 'Email' | translate }}:</span>
                                    <span>{{ selectedBooking.userEmail }}</span>
                                </div>

                                <div>
                                    <span class="font-semibold block">{{ 'Booking Date' | translate }}:</span>
                                    <span>{{ selectedBooking.bookingDate }}</span>
                                </div>

                                <div>
                                    <span class="font-semibold block">{{ 'Status' | translate }}:</span>
                                    <p-tag [value]="selectedBooking.status" [severity]="getStatusSeverity(selectedBooking.status)"></p-tag>
                                </div>
                            </div>
                        </div>

                        <div class="col-12 md:col-6">
                            <h3 class="text-xl font-semibold mb-4">{{ 'Session Information' | translate }}</h3>

                            <div class="flex flex-col gap-3">
                                <div>
                                    <span class="font-semibold block">{{ 'Date' | translate }}:</span>
                                    <span>{{ selectedBooking.timeSlot?.startTime }}</span>
                                </div>

                                <div>
                                    <span class="font-semibold block">{{ 'Time' | translate }}:</span>
                                    <span>{{ selectedBooking.timeSlot?.startTime }} - {{ selectedBooking.timeSlot?.endTime }}</span>
                                </div>

                                <div *ngIf="selectedBooking.notes">
                                    <span class="font-semibold block">{{ 'Notes' | translate }}:</span>
                                    <p class="mt-1 text-gray-600">{{ selectedBooking.notes }}</p>
                                </div>

                                <div class="mt-3 flex gap-2">
                                    <p-button *ngIf="selectedBooking.status === 'pending'" icon="pi pi-check" label="Confirm Booking" styleClass="p-button-success" (onClick)="confirmBooking(selectedBooking); showDetailsDialog = false"> </p-button>

                                    <p-button *ngIf="selectedBooking.status === 'confirmed'" icon="pi pi-check-circle" label="Mark as Completed" styleClass="p-button-primary" (onClick)="completeBooking(selectedBooking); showDetailsDialog = false">
                                    </p-button>
                                </div>
                            </div>
                        </div>

                        <div class="col-12 mt-4" *ngIf="selectedBooking.zoomMeeting">
                            <h3 class="text-xl font-semibold mb-3">{{ 'Zoom Meeting' | translate }}</h3>

                            <div class="grid">
                                <div class="col-12 md:col-6">
                                    <div>
                                        <span class="font-semibold block">{{ 'Meeting ID' | translate }}:</span>
                                        <span>{{ selectedBooking.zoomMeeting.meetingNumber }}</span>
                                    </div>

                                    <div class="mt-2">
                                        <span class="font-semibold block">{{ 'Password' | translate }}:</span>
                                        <span>{{ selectedBooking.zoomMeeting.password }}</span>
                                    </div>
                                </div>

                                <div class="col-12 md:col-6">
                                    <div>
                                        <span class="font-semibold block">{{ 'Start Time' | translate }}:</span>
                                        <span>{{ selectedBooking.zoomMeeting.startTime }}</span>
                                    </div>

                                    <div class="mt-2">
                                        <span class="font-semibold block">{{ 'Duration' | translate }}:</span>
                                        <span>{{ selectedBooking.zoomMeeting.duration }} minutes</span>
                                    </div>
                                </div>

                                <div class="col-12 mt-3">
                                    <p-button *ngIf="isSessionUpcoming(selectedBooking) || isSessionInProgress(selectedBooking)" icon="pi pi-video" label="Join Meeting" styleClass="p-button-success" (onClick)="activeBookingTab = 1"> </p-button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </p-tabPanel>

            <p-tabPanel [header]="'Zoom Meeting' | translate" *ngIf="selectedBooking?.zoomMeeting">
                <app-zoom-meeting [meeting]="selectedBooking?.zoomMeeting" [isHost]="true" (meetingJoined)="onZoomMeetingJoined()" (meetingEnded)="onZoomMeetingEnded()"> </app-zoom-meeting>
            </p-tabPanel>
        </p-tabView>

        <ng-template pTemplate="footer">
            <p-button label="{{ 'Close' | translate }}" icon="pi pi-times" (click)="showDetailsDialog = false" styleClass="p-button-secondary"></p-button>
        </ng-template>
    </p-dialog>
</div>

<!doctype html>
<html lang="ar" dir="rtl">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>🧠 لعبة عمود الذاكرة البصرية</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                min-height: 100vh;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
                padding: 24px;
            }

            .container {
                max-width: 1200px;
                margin: 0 auto;
            }

            header {
                text-align: center;
                margin-bottom: 32px;
            }

            h1 {
                font-size: 3rem;
                font-weight: bold;
                color: white;
                margin-bottom: 16px;
                text-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            }

            .progress-bar {
                background: rgba(255, 255, 255, 0.2);
                backdrop-filter: blur(10px);
                border-radius: 16px;
                padding: 24px;
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            }

            .progress-content {
                display: flex;
                justify-content: space-between;
                align-items: center;
                flex-wrap: wrap;
                gap: 16px;
            }

            .level-info,
            .score-info {
                color: white;
            }

            .level-title {
                font-size: 1.5rem;
                font-weight: bold;
                margin-bottom: 8px;
            }

            .score-info {
                display: flex;
                align-items: center;
                gap: 16px;
            }

            .stars-container {
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .star {
                font-size: 2rem;
                transition: all 0.3s ease;
            }

            .star.active {
                color: #fbbf24;
                animation: pulse 2s infinite;
            }

            .star.inactive {
                color: #9ca3af;
            }

            .score-display {
                font-size: 1.5rem;
                font-weight: bold;
                color: #fbbf24;
            }

            main {
                background: rgba(255, 255, 255, 0.15);
                backdrop-filter: blur(10px);
                border-radius: 24px;
                padding: 32px;
                box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
                min-height: 600px;
            }

            .game-content {
                text-align: center;
            }

            .large-icon {
                font-size: 8rem;
                margin-bottom: 24px;
                animation: bounce 1s infinite;
            }

            .welcome-title {
                font-size: 2.5rem;
                color: white;
                font-weight: bold;
                margin-bottom: 24px;
            }

            .achievement-box {
                background: linear-gradient(to right, #10b981, #3b82f6);
                border-radius: 16px;
                padding: 24px;
                margin: 0 auto 24px;
                max-width: 400px;
            }

            .achievement-stats {
                display: flex;
                justify-content: center;
                gap: 32px;
            }

            .stat-value {
                font-size: 2rem;
                color: #fbbf24;
            }

            .instructions-box {
                background: rgba(255, 255, 255, 0.2);
                border-radius: 12px;
                padding: 24px;
                max-width: 700px;
                margin: 0 auto 32px;
                color: white;
            }

            .instructions-title {
                font-size: 1.25rem;
                margin-bottom: 12px;
            }

            .instructions-list {
                font-size: 1.125rem;
                line-height: 2;
            }

            .start-button {
                background: linear-gradient(to right, #10b981, #3b82f6);
                color: white;
                padding: 24px 48px;
                border-radius: 24px;
                font-size: 2rem;
                font-weight: bold;
                border: none;
                cursor: pointer;
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
                transition: all 0.3s ease;
                animation: pulse 2s infinite;
            }

            .start-button:hover {
                transform: scale(1.05);
            }

            .column-container {
                display: flex;
                justify-content: center;
                gap: 48px;
                align-items: flex-start;
                flex-wrap: wrap;
            }

            .column-section {
                background: rgba(255, 255, 255, 0.2);
                border-radius: 16px;
                padding: 24px;
            }

            .column-title {
                color: white;
                font-size: 1.5rem;
                font-weight: bold;
                text-align: center;
                margin-bottom: 16px;
            }

            .column {
                background: linear-gradient(to bottom, #fcd34d, #fbbf24);
                border-radius: 12px;
                padding: 16px;
                min-height: 400px;
                width: 128px;
                display: flex;
                flex-direction: column;
                justify-content: flex-end;
                align-items: center;
                border: 4px solid #d97706;
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
                position: relative;
                transition: all 0.3s ease;
            }

            .column.complete {
                border-color: #10b981;
                box-shadow: 0 0 20px #10b981;
            }

            .column-base {
                position: absolute;
                bottom: 0;
                left: 0;
                right: 0;
                height: 24px;
                background: #92400e;
                border-bottom-left-radius: 8px;
                border-bottom-right-radius: 8px;
            }

            .column-items {
                display: flex;
                flex-direction: column-reverse;
                align-items: center;
                z-index: 1;
                width: 100%;
            }

            .column-placeholder {
                color: #92400e;
                font-size: 0.875rem;
                text-align: center;
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%) rotate(90deg);
                white-space: nowrap;
            }

            .shape {
                margin: 4px auto;
                cursor: grab;
                transition: all 0.3s ease;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            }

            .shape.draggable:hover {
                transform: scale(1.05);
                box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            }

            .shape.dragging {
                opacity: 0.5;
                transform: rotate(5deg) scale(1.1);
            }

            .shape-circle,
            .shape-bead {
                border-radius: 50%;
                border: 4px solid white;
            }

            .shape-square {
                border: 4px solid white;
                border-radius: 4px;
            }

            .shape-triangle {
                width: 0;
                height: 0;
                filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
            }

            .shape-star {
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-size: 1.25rem;
                clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
            }

            .shape-pool {
                background: rgba(255, 255, 255, 0.2);
                border-radius: 16px;
                padding: 24px;
                max-width: 500px;
            }

            .shape-grid {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 24px;
                justify-items: center;
            }

            .shape-instructions {
                margin-top: 24px;
                text-align: center;
                color: rgba(255, 255, 255, 0.8);
                font-size: 0.875rem;
                background: rgba(255, 255, 255, 0.1);
                border-radius: 8px;
                padding: 12px;
                line-height: 1.6;
            }

            .control-buttons {
                display: flex;
                justify-content: center;
                gap: 16px;
                margin-top: 32px;
                flex-wrap: wrap;
            }

            .control-button {
                padding: 12px 24px;
                border-radius: 12px;
                font-size: 1.125rem;
                font-weight: bold;
                border: none;
                cursor: pointer;
                transition: all 0.3s ease;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
                color: white;
            }

            .control-button:hover:not(:disabled) {
                transform: scale(1.05);
            }

            .control-button:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }

            .button-reset {
                background: #ef4444;
            }

            .button-reset:hover:not(:disabled) {
                background: #dc2626;
            }

            .button-undo {
                background: #eab308;
            }

            .button-undo:hover:not(:disabled) {
                background: #ca8a04;
            }

            .success-content,
            .failure-content {
                position: relative;
                z-index: 10;
            }

            .success-icon,
            .failure-icon {
                font-size: 9rem;
                margin-bottom: 24px;
                animation: bounce 1s infinite;
            }

            .success-title {
                font-size: 4rem;
                color: white;
                font-weight: bold;
                margin-bottom: 24px;
                text-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            }

            .failure-title {
                font-size: 2.5rem;
                color: #fdba74;
                font-weight: bold;
                margin-bottom: 24px;
            }

            .rewards-container {
                display: flex;
                justify-content: center;
                align-items: center;
                gap: 40px;
                margin-bottom: 32px;
                flex-wrap: wrap;
            }

            .reward-badge {
                border-radius: 50%;
                padding: 32px;
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            }

            .reward-stars {
                background: linear-gradient(to right, #fbbf24, #fb923c);
                animation: spin 2s linear infinite;
            }

            .reward-points {
                background: linear-gradient(to right, #10b981, #3b82f6);
                animation: bounce 1s infinite;
            }

            .reward-value {
                font-size: 3rem;
                color: white;
                font-weight: bold;
            }

            .reward-plus {
                color: white;
                font-size: 4rem;
                animation: pulse 2s infinite;
            }

            .next-level-box,
            .tips-box {
                background: rgba(255, 255, 255, 0.3);
                backdrop-filter: blur(10px);
                border-radius: 24px;
                padding: 32px;
                max-width: 500px;
                margin: 0 auto 32px;
                color: white;
            }

            .tips-box {
                background: linear-gradient(to right, #3b82f6, #8b5cf6);
            }

            .retry-buttons {
                display: flex;
                justify-content: center;
                gap: 24px;
                flex-wrap: wrap;
            }

            .retry-button {
                padding: 20px 40px;
                border-radius: 16px;
                font-size: 1.5rem;
                font-weight: bold;
                border: none;
                cursor: pointer;
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
                transition: all 0.3s ease;
                color: white;
            }

            .retry-button:hover {
                transform: scale(1.05);
            }

            .button-retry {
                background: linear-gradient(to right, #3b82f6, #06b6d4);
            }

            .button-review {
                background: linear-gradient(to right, #eab308, #f97316);
            }

            nav {
                margin-top: 32px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .nav-button {
                background: #4b5563;
                color: white;
                padding: 12px 24px;
                border-radius: 12px;
                font-weight: bold;
                border: none;
                cursor: pointer;
                transition: all 0.3s ease;
            }

            .nav-button:hover:not(:disabled) {
                background: #374151;
                transform: scale(1.05);
            }

            .nav-button:disabled {
                background: #9ca3af;
                cursor: not-allowed;
            }

            .progress-indicator {
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .level-dot {
                width: 48px;
                height: 48px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1.25rem;
                font-weight: bold;
                transition: all 0.3s ease;
            }

            .level-dot.current {
                background: white;
                color: #8b5cf6;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
                transform: scale(1.1);
            }

            .level-dot.completed {
                background: #10b981;
                color: white;
            }

            .level-dot.locked {
                background: rgba(255, 255, 255, 0.3);
                color: white;
            }

            .level-connector {
                width: 32px;
                height: 4px;
                background: rgba(255, 255, 255, 0.3);
            }

            footer {
                margin-top: 32px;
                text-align: center;
            }

            .info-box {
                background: rgba(255, 255, 255, 0.1);
                backdrop-filter: blur(10px);
                border-radius: 16px;
                padding: 24px;
                max-width: 800px;
                margin: 0 auto;
                color: white;
            }

            @keyframes pulse {
                0%,
                100% {
                    opacity: 1;
                }
                50% {
                    opacity: 0.5;
                }
            }

            @keyframes bounce {
                0%,
                100% {
                    transform: translateY(-25%);
                    animation-timing-function: cubic-bezier(0.8, 0, 1, 1);
                }
                50% {
                    transform: translateY(0);
                    animation-timing-function: cubic-bezier(0, 0, 0.2, 1);
                }
            }

            @keyframes spin {
                from {
                    transform: rotate(0deg);
                }
                to {
                    transform: rotate(360deg);
                }
            }

            [draggable='true'] {
                user-select: none;
                -webkit-user-select: none;
            }

            .hidden {
                display: none;
            }

            @media (max-width: 768px) {
                h1 {
                    font-size: 2rem;
                }
                .welcome-title {
                    font-size: 1.75rem;
                }
                .success-title {
                    font-size: 2.5rem;
                }
                .column-container {
                    flex-direction: column;
                    align-items: center;
                }
                .shape-grid {
                    grid-template-columns: repeat(2, 1fr);
                }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <header>
                <h1>🧠 لعبة عمود الذاكرة البصرية</h1>

                <div class="progress-bar">
                    <div class="progress-content">
                        <div class="level-info">
                            <div class="level-title" id="levelTitle"></div>
                            <div id="stageInfo"></div>
                        </div>

                        <div class="score-info">
                            <div class="stars-container">
                                <div id="starsDisplay"></div>
                                <span id="starsText"></span>
                            </div>
                            <div class="score-display" id="scoreDisplay">0 نقطة</div>
                        </div>
                    </div>
                </div>
            </header>

            <main id="gameArea"></main>

            <nav>
                <button class="nav-button" id="prevButton">← المرحلة السابقة</button>
                <div class="progress-indicator" id="progressIndicator"></div>
                <button class="nav-button" id="nextButton">المرحلة التالية →</button>
            </nav>

            <footer>
                <div class="info-box">
                    <div style="font-size: 1.125rem; margin-bottom: 12px">🏗️ <strong>لعبة عمود الذاكرة:</strong> اسحب واتركت لبناء العمود!</div>
                    <div style="margin-bottom: 8px">احفظ الترتيب • اسحب القطع • ابني العمود من الأسفل للأعلى</div>
                    <div style="font-size: 0.875rem; opacity: 0.8">مصممة لتطوير الذاكرة البصرية والمهارات الحركية للأطفال</div>
                </div>
            </footer>
        </div>

        <script>
            // Game State
            let gameState = {
                level: 1,
                stage: 1,
                state: 'welcome',
                pattern: [],
                userAnswer: [],
                score: 0,
                stars: 0,
                message: '',
                draggedItem: null
            };

            // Game Settings
            const gameSettings = {
                1: {
                    name: 'الخرز الملونة',
                    icon: '🔴',
                    stages: {
                        1: { items: 3, time: 3000, shapes: ['bead'], colors: ['#FF6B6B', '#4ECDC4'] },
                        2: { items: 3, time: 2500, shapes: ['bead'], colors: ['#FF6B6B', '#4ECDC4', '#45B7D1'] },
                        3: { items: 4, time: 3000, shapes: ['bead'], colors: ['#FF6B6B', '#4ECDC4', '#45B7D1'] },
                        4: { items: 4, time: 2500, shapes: ['bead'], colors: ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4'] },
                        5: { items: 5, time: 3000, shapes: ['bead'], colors: ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4'] }
                    }
                },
                2: {
                    name: 'الأشكال الهندسية',
                    icon: '🔷',
                    stages: {
                        1: { items: 3, time: 2500, shapes: ['circle', 'square'], colors: ['#FF6B6B', '#4ECDC4'] },
                        2: { items: 4, time: 2500, shapes: ['circle', 'square', 'triangle'], colors: ['#FF6B6B', '#4ECDC4', '#45B7D1'] },
                        3: { items: 4, time: 2000, shapes: ['circle', 'square', 'triangle'], colors: ['#FF6B6B', '#4ECDC4', '#45B7D1'] },
                        4: { items: 5, time: 2500, shapes: ['circle', 'square', 'triangle'], colors: ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4'] },
                        5: { items: 5, time: 2000, shapes: ['circle', 'square', 'triangle'], colors: ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4'] }
                    }
                },
                3: {
                    name: 'التحدي المتقدم',
                    icon: '⭐',
                    stages: {
                        1: { items: 4, time: 2000, shapes: ['circle', 'square', 'triangle', 'star'], colors: ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4'] },
                        2: { items: 5, time: 2000, shapes: ['circle', 'square', 'triangle', 'star'], colors: ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FECA57'] },
                        3: { items: 6, time: 1500, shapes: ['circle', 'square', 'triangle', 'star'], colors: ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FECA57'] },
                        4: { items: 6, time: 1500, shapes: ['circle', 'square', 'triangle', 'star'], colors: ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FECA57', '#FF9FF3'] },
                        5: { items: 7, time: 1500, shapes: ['circle', 'square', 'triangle', 'star'], colors: ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FECA57', '#FF9FF3'] }
                    }
                }
            };

            const encouragementMessages = [
                '🌟 رائع جداً! عقلك نشيط ومتألق!',
                '🎉 مذهل! أنت بطل الذاكرة!',
                '⭐ ممتاز! ذاكرتك قوية كالحديد!',
                '🏆 عبقري! أداؤك يستحق التصفيق!',
                '🎯 إنجاز رائع! أنت محترف حقيقي!',
                '🔥 لا يُصدق! قوة تركيزك مدهشة!',
                '💎 بطولي! أنت نجم متألق!',
                '🚀 خارق! عقلك يعمل كالصاروخ!',
                '🌈 إبداعي! أنت تجعلني فخوراً!',
                '⚡ سريع البديهة! ذكاؤك يتوهج!'
            ];

            // Generate random pattern
            function generatePattern() {
                const currentSettings = gameSettings[gameState.level].stages[gameState.stage];
                const newPattern = [];

                for (let i = 0; i < currentSettings.items; i++) {
                    const shape = currentSettings.shapes[Math.floor(Math.random() * currentSettings.shapes.length)];
                    const color = currentSettings.colors[Math.floor(Math.random() * currentSettings.colors.length)];

                    newPattern.push({
                        id: `pattern-${i}`,
                        shape: shape,
                        color: color,
                        position: i
                    });
                }

                return newPattern;
            }

            // Create shape element
            function createShapeElement(item, isInColumn = false, isDraggable = false) {
                const size = isInColumn ? 50 : 60;
                const div = document.createElement('div');
                div.className = 'shape';

                if (isDraggable) {
                    div.classList.add('draggable');
                    div.draggable = true;
                    div.addEventListener('dragstart', (e) => {
                        if (gameState.state === 'playing') {
                            playPickupSound();
                            gameState.draggedItem = item;
                            div.classList.add('dragging');
                            e.dataTransfer.setData('text/plain', JSON.stringify(item));
                            e.dataTransfer.effectAllowed = 'copy';
                        }
                    });
                    div.addEventListener('dragend', () => {
                        gameState.draggedItem = null;
                        div.classList.remove('dragging');
                    });
                }

                switch (item.shape) {
                    case 'bead':
                    case 'circle':
                        div.classList.add('shape-circle');
                        div.style.cssText = `width: ${size}px; height: ${size}px; background-color: ${item.color};`;
                        break;
                    case 'square':
                        div.classList.add('shape-square');
                        div.style.cssText = `width: ${size}px; height: ${size}px; background-color: ${item.color};`;
                        break;
                    case 'triangle':
                        div.classList.add('shape-triangle');
                        div.style.cssText = `border-left: ${size / 2}px solid transparent; border-right: ${size / 2}px solid transparent; border-bottom: ${size}px solid ${item.color}; margin: ${isInColumn ? '4px auto' : '8px'};`;
                        break;
                    case 'star':
                        div.classList.add('shape-star');
                        div.style.cssText = `width: ${size}px; height: ${size}px; background-color: ${item.color};`;
                        div.textContent = '✦';
                        break;
                }

                return div;
            }

            // Create shape pool
            function createShapePool() {
                const currentSettings = gameSettings[gameState.level].stages[gameState.stage];
                const pool = [];

                currentSettings.shapes.forEach((shape) => {
                    currentSettings.colors.forEach((color) => {
                        pool.push({
                            id: `pool-${shape}-${color}`,
                            shape,
                            color
                        });
                    });
                });

                return pool;
            }

            // Check answer
            function checkAnswer() {
                if (gameState.userAnswer.length !== gameState.pattern.length) return;

                const isCorrect = gameState.userAnswer.every((item, index) => item.shape === gameState.pattern[index].shape && item.color === gameState.pattern[index].color);

                if (isCorrect) {
                    const earnedStars = 3;
                    const earnedPoints = earnedStars * 10;
                    gameState.score += earnedPoints;
                    gameState.stars += earnedStars;
                    gameState.message = encouragementMessages[Math.floor(Math.random() * encouragementMessages.length)];
                    gameState.state = 'success';
                    playSuccessSound();
                    render();

                    setTimeout(() => {
                        if (gameState.stage < 5) {
                            gameState.stage++;
                        } else if (gameState.level < 3) {
                            gameState.level++;
                            gameState.stage = 1;
                        }
                        gameState.state = 'welcome';
                        render();
                    }, 3000);
                } else {
                    gameState.state = 'failure';
                    playFailSound();
                    render();
                }
            }

            // Start game
            function startGame() {
                const newPattern = generatePattern();
                gameState.pattern = newPattern;
                gameState.userAnswer = [];
                gameState.state = 'showing';
                playShowSound();
                render();

                const showTime = gameSettings[gameState.level].stages[gameState.stage].time;

                setTimeout(() => {
                    gameState.state = 'playing';
                    render();
                }, showTime);
            }

            // Sound Functions
            function playSuccessSound() {
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const frequencies = [523.25, 659.25, 783.99, 1046.5, 1318.51];

                    frequencies.forEach((freq, index) => {
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();

                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);

                        oscillator.frequency.value = freq;
                        oscillator.type = 'sine';

                        gainNode.gain.setValueAtTime(0, audioContext.currentTime + index * 0.1);
                        gainNode.gain.linearRampToValueAtTime(0.2, audioContext.currentTime + index * 0.1 + 0.02);
                        gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + index * 0.1 + 0.5);

                        oscillator.start(audioContext.currentTime + index * 0.1);
                        oscillator.stop(audioContext.currentTime + index * 0.1 + 0.5);
                    });
                } catch (e) {
                    console.log('Audio not supported');
                }
            }

            function playFailSound() {
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();

                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);

                    oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(100, audioContext.currentTime + 0.5);
                    oscillator.type = 'sawtooth';

                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.5);

                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.5);
                } catch (e) {
                    console.log('Audio not supported');
                }
            }

            function playPickupSound() {
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();

                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);

                    oscillator.frequency.value = 600;
                    oscillator.type = 'sine';

                    gainNode.gain.setValueAtTime(0.15, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.2);

                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.2);
                } catch (e) {
                    console.log('Audio not supported');
                }
            }

            function playDropSound() {
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();

                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);

                    oscillator.frequency.value = 400;
                    oscillator.type = 'sine';

                    gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.3);

                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.3);
                } catch (e) {
                    console.log('Audio not supported');
                }
            }

            function playShowSound() {
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();

                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);

                    oscillator.frequency.value = 440;
                    oscillator.type = 'sine';

                    gainNode.gain.setValueAtTime(0.15, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.3);

                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.3);
                } catch (e) {
                    console.log('Audio not supported');
                }
            }

            function playDeleteSound() {
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();

                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);

                    oscillator.frequency.value = 250;
                    oscillator.type = 'triangle';

                    gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.3);

                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.3);
                } catch (e) {
                    console.log('Audio not supported');
                }
            }

            // Navigation
            function goToLevel(newLevel, newStage) {
                if (newLevel >= 1 && newLevel <= 3 && newStage >= 1 && newStage <= 5) {
                    gameState.level = newLevel;
                    gameState.stage = newStage;
                    gameState.state = 'welcome';
                    render();
                }
            }

            // Update header display
            function updateHeader() {
                const levelTitle = document.getElementById('levelTitle');
                const stageInfo = document.getElementById('stageInfo');
                const starsDisplay = document.getElementById('starsDisplay');
                const starsText = document.getElementById('starsText');
                const scoreDisplay = document.getElementById('scoreDisplay');

                levelTitle.textContent = `${gameSettings[gameState.level].icon} المستوى ${gameState.level}: ${gameSettings[gameState.level].name}`;
                stageInfo.textContent = `المرحلة ${gameState.stage} من 5`;

                // Display stars
                starsDisplay.innerHTML = '';
                for (let i = 1; i <= 5; i++) {
                    const star = document.createElement('span');
                    star.className = 'star';
                    star.textContent = '⭐';
                    if (i <= (gameState.stars % 5 === 0 && gameState.stars > 0 ? 5 : gameState.stars % 5)) {
                        star.classList.add('active');
                    } else {
                        star.classList.add('inactive');
                    }
                    starsDisplay.appendChild(star);
                }

                const starsCount = gameState.stars % 5 || (gameState.stars > 0 ? 5 : 0);
                const starsMultiplier = Math.floor(gameState.stars / 5);
                starsText.textContent = `${starsMultiplier > 0 ? starsMultiplier + '×5 + ' : ''}${starsCount} نجوم`;

                scoreDisplay.textContent = `${gameState.score} نقطة`;
            }

            // Update navigation
            function updateNavigation() {
                const prevButton = document.getElementById('prevButton');
                const nextButton = document.getElementById('nextButton');
                const progressIndicator = document.getElementById('progressIndicator');

                prevButton.disabled = gameState.level === 1 && gameState.stage === 1;
                nextButton.disabled = gameState.level === 3 && gameState.stage === 5;

                prevButton.onclick = () => {
                    if (gameState.stage > 1) {
                        goToLevel(gameState.level, gameState.stage - 1);
                    } else if (gameState.level > 1) {
                        goToLevel(gameState.level - 1, 5);
                    }
                };

                nextButton.onclick = () => {
                    if (gameState.stage < 5) {
                        goToLevel(gameState.level, gameState.stage + 1);
                    } else if (gameState.level < 3) {
                        goToLevel(gameState.level + 1, 1);
                    }
                };

                // Progress dots
                progressIndicator.innerHTML = '';
                for (let i = 1; i <= 3; i++) {
                    const dot = document.createElement('div');
                    dot.className = 'level-dot';
                    dot.textContent = gameSettings[i].icon;

                    if (i === gameState.level) {
                        dot.classList.add('current');
                    } else if (i < gameState.level) {
                        dot.classList.add('completed');
                    } else {
                        dot.classList.add('locked');
                    }

                    progressIndicator.appendChild(dot);

                    if (i < 3) {
                        const connector = document.createElement('div');
                        connector.className = 'level-connector';
                        progressIndicator.appendChild(connector);
                    }
                }
            }

            // Render game
            function render() {
                const gameArea = document.getElementById('gameArea');
                gameArea.innerHTML = '';

                updateHeader();
                updateNavigation();

                const content = document.createElement('div');
                content.className = 'game-content';

                if (gameState.state === 'welcome') {
                    content.innerHTML = `
          <div class="large-icon">🎯</div>
          <h2 class="welcome-title">مستعد لبناء عمود الذاكرة؟</h2>
          ${
              gameState.score > 0
                  ? `
            <div class="achievement-box">
              <div style="color: white; font-size: 1.5rem; font-weight: bold; margin-bottom: 8px;">🏆 إنجازاتك</div>
              <div class="achievement-stats">
                <div>
                  <div class="stat-value">${gameState.stars}</div>
                  <div style="font-size: 0.875rem; color: white;">نجمة</div>
                </div>
                <div>
                  <div class="stat-value">${gameState.score}</div>
                  <div style="font-size: 0.875rem; color: white;">نقطة</div>
                </div>
              </div>
            </div>
          `
                  : ''
          }
          <div class="instructions-box">
            <div class="instructions-title">🏗️ كيفية اللعب:</div>
            <div class="instructions-list">
              <div>• احفظ ترتيب ${gameSettings[gameState.level].stages[gameState.stage].items} قطع في العمود</div>
              <div>• اسحب القطع من الأسفل واتركها في العمود</div>
              <div>• ابني العمود بنفس الترتيب من الأسفل للأعلى!</div>
            </div>
            <div style="color: #fbbf24; font-weight: bold; margin-top: 12px;">
              ⏰ زمن المشاهدة: ${gameSettings[gameState.level].stages[gameState.stage].time / 1000} ثانية
            </div>
          </div>
        `;

                    const button = document.createElement('button');
                    button.className = 'start-button';
                    button.textContent = '🚀 ابدأ البناء!';
                    button.onclick = startGame;
                    content.appendChild(button);
                } else if (gameState.state === 'showing') {
                    content.innerHTML = `
          <h2 class="welcome-title">احفظ ترتيب القطع في العمود! 👀</h2>
          <div style="display: flex; justify-content: center;">
            <div id="showColumn" class="column">
              <div class="column-base"></div>
              <div class="column-items" id="showColumnItems"></div>
            </div>
          </div>
          <div style="color: white; font-size: 1.5rem; margin-top: 24px; animation: pulse 2s infinite;">
            ⏰ ركز على الترتيب من الأسفل إلى الأعلى!
          </div>
        `;

                    setTimeout(() => {
                        const columnItems = document.getElementById('showColumnItems');
                        if (columnItems) {
                            gameState.pattern.forEach((item, index) => {
                                columnItems.appendChild(createShapeElement({ ...item, id: `show-${index}` }, true));
                            });
                        }
                    }, 100);
                } else if (gameState.state === 'playing') {
                    content.innerHTML = `
          <h2 class="welcome-title">اسحب القطع وابني العمود! 🏗️</h2>
          <div class="column-container">
            <div class="column-section">
              <h3 class="column-title">عمود البناء (${gameState.userAnswer.length}/${gameState.pattern.length})</h3>
              <div id="buildColumn" class="column">
                <div class="column-base"></div>
                <div class="column-items" id="buildColumnItems"></div>
                ${gameState.userAnswer.length === 0 ? '<div class="column-placeholder">اسحب القطع هنا</div>' : ''}
              </div>
            </div>
            <div class="shape-pool">
              <h3 class="column-title">اسحب من هنا:</h3>
              <div class="shape-grid" id="shapeGrid"></div>
              <div class="shape-instructions">
                💡 اسحب القطع من هنا واتركها في العمود<br>
                🔄 ابدأ من القطعة الأولى (الأسفل) إلى الأخيرة (الأعلى)
              </div>
            </div>
          </div>
        `;

                    setTimeout(() => {
                        const buildColumn = document.getElementById('buildColumn');
                        const buildColumnItems = document.getElementById('buildColumnItems');
                        const shapeGrid = document.getElementById('shapeGrid');

                        // Setup drop zone
                        buildColumn.addEventListener('dragover', (e) => {
                            e.preventDefault();
                            e.dataTransfer.dropEffect = 'copy';
                        });

                        buildColumn.addEventListener('drop', (e) => {
                            e.preventDefault();
                            playDropSound();

                            const droppedItem = JSON.parse(e.dataTransfer.getData('text/plain'));
                            const newItem = {
                                ...droppedItem,
                                id: `answer-${gameState.userAnswer.length}`
                            };

                            gameState.userAnswer.push(newItem);

                            if (gameState.userAnswer.length === gameState.pattern.length) {
                                buildColumn.classList.add('complete');
                                setTimeout(checkAnswer, 500);
                            }

                            render();
                        });

                        // Display user answer
                        gameState.userAnswer.forEach((item, index) => {
                            buildColumnItems.appendChild(createShapeElement({ ...item, id: `built-${index}` }, true));
                        });

                        // Display shape pool
                        const pool = createShapePool();
                        pool.forEach((item) => {
                            shapeGrid.appendChild(createShapeElement(item, false, true));
                        });
                    }, 100);

                    const controlButtons = document.createElement('div');
                    controlButtons.className = 'control-buttons';
                    controlButtons.innerHTML = `
          <button class="control-button button-reset">هدم العمود 🗑️</button>
          <button class="control-button button-undo" ${gameState.userAnswer.length === 0 ? 'disabled' : ''}>إزالة الأخيرة ↶</button>
        `;
                    content.appendChild(controlButtons);

                    setTimeout(() => {
                        document.querySelector('.button-reset').onclick = () => {
                            playDeleteSound();
                            gameState.userAnswer = [];
                            render();
                        };
                        document.querySelector('.button-undo').onclick = () => {
                            if (gameState.userAnswer.length > 0) {
                                playDeleteSound();
                                gameState.userAnswer.pop();
                                render();
                            }
                        };
                    }, 100);
                } else if (gameState.state === 'success') {
                    content.innerHTML = `
          <div class="success-content">
            <div class="success-icon">🏆</div>
            <h1 class="success-title">${gameState.message}</h1>
            <div class="rewards-container">
              <div class="reward-badge reward-stars">
                <div class="reward-value">+3⭐</div>
              </div>
              <div class="reward-plus">+</div>
              <div class="reward-badge reward-points">
                <div class="reward-value">+30🏅</div>
              </div>
            </div>
            <div class="next-level-box">
              <div style="font-size: 2rem; font-weight: bold; margin-bottom: 16px;">🚀 المرحلة التالية:</div>
              <div style="font-size: 1.5rem; margin-bottom: 16px;">
                ${
                    gameState.stage < 5
                        ? `المستوى ${gameState.level} - المرحلة ${gameState.stage + 1}`
                        : gameState.level < 3
                          ? `${gameSettings[gameState.level + 1].icon} ${gameSettings[gameState.level + 1].name}`
                          : '🎯 مبروك! لقد أكملت جميع التحديات!'
                }
              </div>
              <div style="background: rgba(255,255,255,0.2); border-radius: 16px; padding: 16px;">
                <div style="color: #fbbf24; font-size: 1.125rem; font-weight: bold;">إجمالي الإنجازات:</div>
                <div style="font-size: 1.125rem;">⭐ ${gameState.stars} نجمة | 🏅 ${gameState.score} نقطة</div>
              </div>
            </div>
            <div style="margin-top: 32px; color: white; font-size: 1.5rem; animation: pulse 2s infinite;">
              ⏰ الانتقال تلقائياً خلال لحظات...
            </div>
          </div>
        `;
                } else if (gameState.state === 'failure') {
                    content.innerHTML = `
          <div class="failure-content">
            <div class="failure-icon">😊</div>
            <h2 class="failure-title">لا بأس! البناء يحتاج تدريب! 🏗️</h2>
            <div class="tips-box">
              <div style="font-size: 1.5rem; font-weight: bold; margin-bottom: 16px;">🧠 نصائح البناء:</div>
              <div style="font-size: 1.125rem; line-height: 2;">
                <div>• ركز على القطعة السفلى أولاً</div>
                <div>• تذكر الألوان والأشكال معاً</div>
                <div>• ابني من الأسفل إلى الأعلى</div>
              </div>
              <div style="color: #bfdbfe; font-size: 0.875rem; margin-top: 16px;">
                🎯 كل محاولة تقوي ذاكرتك!
              </div>
            </div>
            <div class="retry-buttons">
              <button class="retry-button button-retry">محاولة جديدة 🔄</button>
              <button class="retry-button button-review">شاهد العمود مرة أخرى 👁️</button>
            </div>
          </div>
        `;

                    setTimeout(() => {
                        document.querySelector('.button-retry').onclick = startGame;
                        document.querySelector('.button-review').onclick = () => {
                            gameState.state = 'showing';
                            render();
                            setTimeout(() => {
                                gameState.state = 'playing';
                                render();
                            }, gameSettings[gameState.level].stages[gameState.stage].time + 1000);
                        };
                    }, 100);
                }

                gameArea.appendChild(content);
            }

            // Initialize game
            render();
        </script>
    </body>
</html>

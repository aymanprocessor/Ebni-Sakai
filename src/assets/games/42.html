<!doctype html>
<html lang="ar" dir="rtl">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>لعبة تدريب الذاكرة</title>
        <style>
            @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap');

            body {
                font-family: 'Cairo', sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                margin: 0;
                padding: 20px;
                min-height: 100vh;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .game-container {
                background: rgba(255, 255, 255, 0.95);
                border-radius: 20px;
                padding: 30px;
                box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
                text-align: center;
                max-width: 700px;
                width: 100%;
            }

            .game-title {
                color: #4a5568;
                font-size: 32px;
                font-weight: 700;
                margin-bottom: 20px;
            }

            .level-info {
                background: linear-gradient(135deg, #ff6b6b, #ee5a24);
                color: white;
                padding: 15px;
                border-radius: 15px;
                margin-bottom: 20px;
                font-size: 18px;
                font-weight: 600;
            }

            .progress-bar {
                background: #e2e8f0;
                height: 10px;
                border-radius: 5px;
                margin: 15px 0;
                overflow: hidden;
            }

            .progress-fill {
                background: linear-gradient(135deg, #4facfe, #00f2fe);
                height: 100%;
                transition: width 0.3s ease;
            }

            .main-display {
                width: 250px;
                height: 250px;
                border: 5px solid #4a90e2;
                border-radius: 20px;
                margin: 20px auto;
                display: flex;
                align-items: center;
                justify-content: center;
                background: white;
                box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
                overflow: hidden;
                position: relative;
            }

            .main-display img {
                width: 100%;
                height: 100%;
                object-fit: contain;
                border-radius: 15px;
            }

            .main-display.reference {
                border-color: #28a745;
                background: linear-gradient(135deg, #d4edda, #c3e6cb);
            }

            .emoji-display {
                font-size: 120px;
                line-height: 1;
                display: flex;
                align-items: center;
                justify-content: center;
                width: 100%;
                height: 100%;
            }

            .question-mark {
                font-size: 120px;
                color: #4a90e2;
                font-weight: bold;
                animation: pulse 1.5s infinite;
            }

            @keyframes pulse {
                0%,
                100% {
                    transform: scale(1);
                }
                50% {
                    transform: scale(1.1);
                }
            }

            .timer {
                font-size: 36px;
                font-weight: 700;
                color: #e53e3e;
                margin: 15px 0;
                min-height: 45px;
                animation: countdown 1s infinite;
            }

            @keyframes countdown {
                0%,
                100% {
                    color: #e53e3e;
                }
                50% {
                    color: #ff6b6b;
                }
            }

            .display-title {
                font-size: 20px;
                font-weight: 600;
                color: #2d3748;
                margin: 15px 0;
            }

            .question-text {
                font-size: 22px;
                font-weight: 600;
                color: #2d3748;
                margin: 20px 0;
                line-height: 1.4;
            }

            .answer-buttons {
                display: flex;
                gap: 15px;
                justify-content: center;
                margin: 30px 0;
                flex-wrap: wrap;
                max-width: 100%;
            }

            .choice-btn {
                padding: 15px 20px;
                font-size: 16px;
                font-weight: 700;
                border: 3px solid #4a90e2;
                border-radius: 15px;
                cursor: pointer;
                transition: all 0.3s ease;
                min-width: 100px;
                min-height: 100px;
                background: white;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .choice-btn:hover {
                transform: translateY(-5px);
                box-shadow: 0 15px 25px rgba(0, 0, 0, 0.3);
                border-color: #2d3748;
                background: #f7fafc;
            }

            .choice-btn:disabled {
                opacity: 0.5;
                cursor: not-allowed;
                transform: none;
            }

            .choice-btn.correct {
                border-color: #48bb78;
                background: #c6f6d5;
                animation: correctPulse 0.6s ease-in-out;
            }

            .choice-btn.wrong {
                border-color: #f56565;
                background: #fed7d7;
                animation: shake 0.6s ease-in-out;
            }

            @keyframes correctPulse {
                0%,
                100% {
                    transform: scale(1);
                }
                50% {
                    transform: scale(1.1);
                }
            }

            @keyframes shake {
                0%,
                100% {
                    transform: translateX(0);
                }
                25% {
                    transform: translateX(-10px);
                }
                75% {
                    transform: translateX(10px);
                }
            }

            .start-btn {
                background: linear-gradient(135deg, #667eea, #764ba2);
                color: white;
                padding: 25px 60px;
                font-size: 22px;
                font-weight: 700;
                border: none;
                border-radius: 50px;
                cursor: pointer;
                transition: all 0.3s ease;
                box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            }

            .start-btn:hover {
                transform: translateY(-5px);
                box-shadow: 0 20px 35px rgba(0, 0, 0, 0.3);
            }

            .feedback {
                font-size: 24px;
                font-weight: 700;
                margin: 20px 0;
                padding: 15px;
                border-radius: 15px;
                min-height: 30px;
            }

            .correct {
                background: linear-gradient(135deg, #d4edda, #c3e6cb);
                color: #155724;
                animation: celebration 0.8s ease-in-out;
            }

            .incorrect {
                background: linear-gradient(135deg, #f8d7da, #f5c6cb);
                color: #721c24;
                animation: shake 0.6s ease-in-out;
            }

            @keyframes celebration {
                0%,
                100% {
                    transform: scale(1) rotate(0deg);
                }
                25% {
                    transform: scale(1.1) rotate(3deg);
                }
                75% {
                    transform: scale(1.1) rotate(-3deg);
                }
            }

            .level-complete {
                background: linear-gradient(135deg, #ffd700, #ffed4e);
                color: #744210;
                padding: 25px;
                border-radius: 20px;
                font-size: 24px;
                font-weight: 700;
                animation: bounce 1s infinite;
            }

            @keyframes bounce {
                0%,
                100% {
                    transform: translateY(0);
                }
                50% {
                    transform: translateY(-10px);
                }
            }

            .hidden {
                display: none;
            }

            .welcome-instructions {
                font-size: 18px;
                color: #4a5568;
                line-height: 1.6;
                margin: 20px 0;
                background: rgba(255, 255, 255, 0.8);
                padding: 20px;
                border-radius: 15px;
                border: 2px solid #e2e8f0;
            }

            .stats {
                background: rgba(74, 144, 226, 0.1);
                padding: 10px;
                border-radius: 10px;
                margin: 10px 0;
                font-size: 16px;
                color: #2d3748;
            }

            @media (max-width: 600px) {
                .main-display {
                    width: 200px;
                    height: 200px;
                }

                .answer-buttons {
                    gap: 10px;
                }

                .choice-btn {
                    min-width: 80px;
                    min-height: 80px;
                    padding: 10px;
                }

                .choice-btn img {
                    width: 50px !important;
                    height: 50px !important;
                }

                .choice-btn span {
                    font-size: 30px !important;
                }
            }
        </style>
    </head>
    <body>
        <div class="game-container">
            <h1 class="game-title">🧠 لعبة تدريب الذاكرة</h1>

            <!-- شاشة الترحيب -->
            <div id="welcome-screen">
                <div class="level-info">
                    <div>المستوى الأول: الأشكال والألوان 🎨 (5 ثوانِ)</div>
                    <div>المستوى الثاني: الحيوانات 🐘 (4 ثوانِ)</div>
                    <div>المستوى الثالث: الوجوه والأدوات 😊 (3 ثوانِ)</div>
                </div>
                <div class="welcome-instructions">
                    <strong>كيفية اللعب:</strong><br />
                    1️⃣ ستظهر لك صورة أساسية - احفظها جيداً!<br />
                    2️⃣ ثم ستختفي وتظهر علامة استفهام<br />
                    3️⃣ بعدها ستظهر عدة خيارات<br />
                    4️⃣ اختر الصورة التي تطابق الصورة الأساسية<br />
                    5️⃣ كل شكل أساسي يظهر مرة واحدة فقط!<br />
                    <strong>✨ اللعبة تصبح أصعب مع كل محاولة خاطئة!</strong>
                </div>
                <button class="start-btn" onclick="startGame()">🚀 ابدأ اللعب</button>
            </div>

            <!-- شاشة اللعب -->
            <div id="game-screen" class="hidden">
                <div class="level-info">
                    <span id="level-display">المستوى 1</span> -
                    <span id="round-display">الجولة 1 من 5</span>
                </div>

                <div class="stats">
                    <span id="used-images-count">الأشكال المستخدمة: 0</span> |
                    <span id="attempt-count">المحاولة: 1</span>
                </div>

                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                </div>

                <div class="display-title" id="display-title">الصورة الأساسية - احفظها جيداً!</div>

                <div class="timer" id="timer">5</div>

                <div class="main-display reference" id="main-display">
                    <!-- الصورة ستظهر هنا -->
                </div>

                <!-- منطقة السؤال -->
                <div id="question-section" class="hidden">
                    <div class="question-text">اختر الصورة التي تطابق الصورة الأساسية:</div>

                    <div class="answer-buttons" id="answer-buttons">
                        <!-- سيتم إنشاء الأزرار ديناميكياً -->
                    </div>
                </div>

                <div class="feedback" id="feedback"></div>
            </div>

            <!-- شاشة إكمال المستوى -->
            <div id="level-complete-screen" class="hidden">
                <div class="level-complete" id="level-complete-message"></div>
                <button class="start-btn" onclick="nextLevel()" id="next-level-btn">المستوى التالي 🎯</button>
            </div>

            <!-- شاشة إكمال اللعبة -->
            <div id="game-complete-screen" class="hidden">
                <div class="level-complete">
                    🎉 مبروك! لقد أكملت جميع المستويات بنجاح! 🎉<br />
                    أنت بطل الذاكرة! 🏆<br />
                    <div style="font-size: 18px; margin-top: 15px">استخدمت جميع الأشكال دون تكرار! 🌟</div>
                </div>
                <button class="start-btn" onclick="restartGame()">العب مرة أخرى 🔄</button>
            </div>
        </div>

        <script>
            // متغيرات اللعبة
            let currentLevel = 1;
            let currentRound = 1;
            let baseImageSrc = '';
            let gameTimer = null;
            let isGameRunning = false;
            let buttonsDisabled = false;
            let usedImages = new Set(); // استخدام Set لمنع التكرار نهائياً
            let currentChoices = [];
            let correctAnswerIndex = -1;
            let attemptCount = 0;
            let allLevelImages = new Set(); // جميع الصور في المستوى الحالي

            // بيانات المستويات - صور فريدة لكل مستوى
            const gameLevels = {
                1: {
                    name: 'الأشكال والألوان',
                    displayTime: 5,
                    images: [
                        // دوائر ملونة
                        'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSIxMDAiIGN5PSIxMDAiIHI9IjgwIiBmaWxsPSIjZmY2YjZiIi8+PC9zdmc+',
                        'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSIxMDAiIGN5PSIxMDAiIHI9IjgwIiBmaWxsPSIjNDhjYWY1Ii8+PC9zdmc+',
                        'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSIxMDAiIGN5PSIxMDAiIHI9IjgwIiBmaWxsPSIjNDhiYjc4Ii8+PC9zdmc+',
                        'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSIxMDAiIGN5PSIxMDAiIHI9IjgwIiBmaWxsPSIjZmZkNzAwIi8+PC9zdmc+',
                        // مربعات ملونة
                        'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB4PSIyMCIgeT0iMjAiIHdpZHRoPSIxNjAiIGhlaWdodD0iMTYwIiBmaWxsPSIjOWY3YWVhIi8+PC9zdmc+',
                        'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB4PSIyMCIgeT0iMjAiIHdpZHRoPSIxNjAiIGhlaWdodD0iMTYwIiBmaWxsPSIjZmY2MzQ3Ii8+PC9zdmc+',
                        'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB4PSIyMCIgeT0iMjAiIHdpZHRoPSIxNjAiIGhlaWdodD0iMTYwIiBmaWxsPSIjNjM2NmYxIi8+PC9zdmc+',
                        // مثلثات ملونة
                        'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cG9seWdvbiBwb2ludHM9IjEwMCwyMCAxODAsMTgwIDIwLDE4MCIgZmlsbD0iI2VkNTY1MyIvPjwvc3ZnPg==',
                        'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cG9seWdvbiBwb2ludHM9IjEwMCwyMCAxODAsMTgwIDIwLDE4MCIgZmlsbD0iIzM0ZDM5OSIvPjwvc3ZnPg==',
                        'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cG9seWdvbiBwb2ludHM9IjEwMCwyMCAxODAsMTgwIDIwLDE4MCIgZmlsbD0iI2Y2YWQ1NSIvPjwvc3ZnPg==',
                        // نجوم ملونة
                        'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cG9seWdvbiBwb2ludHM9IjEwMCwyMCAxMjUsNzUgMTgwLDc1IDEzNSwxMTUgMTU1LDE3MCAxMDAsMTQwIDQ1LDE3MCA2NSwxMTUgMjAsNzUgNzUsNzUiIGZpbGw9IiNmZmNkMzQiLz48L3N2Zz4=',
                        'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cG9seWdvbiBwb2ludHM9IjEwMCwyMCAxMjUsNzUgMTgwLDc1IDEzNSwxMTUgMTU1LDE3MCAxMDAsMTQwIDQ1LDE3MCA2NSwxMTUgMjAsNzUgNzUsNzUiIGZpbGw9IiNlZDY0YTYiLz48L3N2Zz4=',
                        'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cG9seWdvbiBwb2ludHM9IjEwMCwyMCAxMjUsNzUgMTgwLDc1IDEzNSwxMTUgMTU1LDE3MCAxMDAsMTQwIDQ1LDE3MCA2NSwxMTUgMjAsNzUgNzUsNzUiIGZpbGw9IiM4MWU2ZDkiLz48L3N2Zz4='
                    ]
                },
                2: {
                    name: 'الحيوانات',
                    displayTime: 4,
                    images: ['🐘', '🐴', '🐠', '🦁', '🐸', '🐄', '🦒', '🐨', '🐧', '🦆', '🐷', '🐰', '🐙', '🦀', '🐢']
                },
                3: {
                    name: 'الوجوه والأدوات',
                    displayTime: 3,
                    images: ['😊', '😎', '🤔', '😍', '🤗', '🏠', '🚗', '📱', '⚽', '🎸', '🍎', '⭐', '🌺', '🔔', '🎯']
                }
            };

            // وظائف الأصوات
            function playSuccessSound() {
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();

                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);

                    oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime);
                    oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1);
                    oscillator.frequency.setValueAtTime(783.99, audioContext.currentTime + 0.2);

                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.4);

                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.4);
                } catch (e) {
                    console.log('Audio not available');
                }
            }

            function playFailSound() {
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();

                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);

                    oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
                    oscillator.frequency.setValueAtTime(150, audioContext.currentTime + 0.2);

                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.5);
                } catch (e) {
                    console.log('Audio not available');
                }
            }

            // تعطيل/تفعيل الأزرار
            function setButtonsDisabled(disabled) {
                buttonsDisabled = disabled;
                const buttons = document.querySelectorAll('.choice-btn');
                buttons.forEach((btn) => {
                    btn.disabled = disabled;
                });
            }

            // بدء اللعبة
            function startGame() {
                document.getElementById('welcome-screen').classList.add('hidden');
                document.getElementById('game-screen').classList.remove('hidden');
                isGameRunning = true;
                currentLevel = 1;
                currentRound = 1;
                resetGameData();
                startNewRound();
            }

            // إعادة تعيين بيانات اللعبة
            function resetGameData() {
                usedImages = new Set();
                allLevelImages = new Set(gameLevels[currentLevel].images);
                attemptCount = 0;
            }

            // بدء جولة جديدة
            function startNewRound() {
                updateGameDisplay();
                resetFeedback();
                setButtonsDisabled(true);
                attemptCount = 0;

                // التحقق من وجود صور متاحة
                const availableImages = Array.from(allLevelImages).filter((img) => !usedImages.has(img));

                if (availableImages.length === 0) {
                    // إذا انتهت جميع الصور، انتقل للمستوى التالي
                    completeLevel();
                    return;
                }

                // اختيار صورة أساسية جديدة
                baseImageSrc = availableImages[Math.floor(Math.random() * availableImages.length)];
                usedImages.add(baseImageSrc);

                // عرض الصورة الأساسية
                showBaseImage();
            }

            // عرض الصورة الأساسية
            function showBaseImage() {
                const displayElement = document.getElementById('main-display');
                const titleElement = document.getElementById('display-title');
                const timerElement = document.getElementById('timer');

                // إعداد العرض
                displayElement.className = 'main-display reference';

                // عرض الصورة حسب النوع
                if (currentLevel === 1) {
                    displayElement.innerHTML = `<img src="${baseImageSrc}" alt="الصورة الأساسية">`;
                } else {
                    displayElement.innerHTML = `<div class="emoji-display">${baseImageSrc}</div>`;
                }

                titleElement.textContent = 'الصورة الأساسية - احفظها جيداً!';

                // إخفاء قسم السؤال
                document.getElementById('question-section').classList.add('hidden');

                // بدء العد التنازلي
                let timeLeft = gameLevels[currentLevel].displayTime;
                timerElement.textContent = timeLeft;

                // مسح أي مؤقت سابق
                if (gameTimer) {
                    clearInterval(gameTimer);
                }

                gameTimer = setInterval(() => {
                    timeLeft--;
                    timerElement.textContent = timeLeft;

                    if (timeLeft <= 0) {
                        clearInterval(gameTimer);
                        gameTimer = null;
                        hideBaseImageAndShowQuestion();
                    }
                }, 1000);
            }

            // إخفاء الصورة الأساسية وعرض السؤال
            function hideBaseImageAndShowQuestion() {
                const displayElement = document.getElementById('main-display');
                const titleElement = document.getElementById('display-title');
                const timerElement = document.getElementById('timer');

                // إخفاء الصورة وعرض علامة استفهام
                displayElement.className = 'main-display';
                displayElement.innerHTML = '<div class="question-mark">؟</div>';
                titleElement.textContent = 'تذكر الصورة الأساسية!';
                timerElement.textContent = '';

                // تحضير صورة الاختبار بعد ثانيتين
                setTimeout(() => {
                    prepareTestImage();
                }, 2000);
            }

            // تحضير صورة الاختبار
            function prepareTestImage() {
                attemptCount++;
                const levelImages = gameLevels[currentLevel].images;

                // تحديد عدد الاختيارات (يزيد مع المحاولات)
                let numChoices = Math.min(2 + attemptCount, 6);

                // تحديد ما إذا كانت الإجابة الصحيحة موجودة
                // في المحاولات الأولى، قد لا تكون الإجابة الصحيحة موجودة
                const includeCorrectAnswer = attemptCount >= 2 || Math.random() < 0.3;

                // إنشاء مجموعة الاختيارات
                currentChoices = [];
                correctAnswerIndex = -1;

                // إضافة الإجابة الصحيحة إذا كانت مطلوبة
                if (includeCorrectAnswer) {
                    correctAnswerIndex = Math.floor(Math.random() * numChoices);
                }

                for (let i = 0; i < numChoices; i++) {
                    if (i === correctAnswerIndex) {
                        // الإجابة الصحيحة
                        currentChoices.push(baseImageSrc);
                    } else {
                        // إجابة خاطئة
                        let wrongImage;
                        let attempts = 0;
                        do {
                            wrongImage = levelImages[Math.floor(Math.random() * levelImages.length)];
                            attempts++;
                        } while ((wrongImage === baseImageSrc || currentChoices.includes(wrongImage)) && attempts < 20);
                        currentChoices.push(wrongImage);
                    }
                }

                // خلط الاختيارات
                shuffleArray(currentChoices);

                // تحديث موقع الإجابة الصحيحة بعد الخلط
                if (includeCorrectAnswer) {
                    correctAnswerIndex = currentChoices.indexOf(baseImageSrc);
                }

                // عرض صورة الاختبار والسؤال
                showTestQuestion();
            }

            // خلط المصفوفة
            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
            }

            // عرض سؤال الاختبار
            function showTestQuestion() {
                const titleElement = document.getElementById('display-title');
                const questionSection = document.getElementById('question-section');
                const answerButtons = document.getElementById('answer-buttons');

                titleElement.textContent = 'اختر الصورة المطابقة للصورة الأساسية';

                // إنشاء أزرار الاختيارات
                answerButtons.innerHTML = '';

                currentChoices.forEach((choice, index) => {
                    const button = document.createElement('button');
                    button.className = 'choice-btn';
                    button.onclick = () => selectChoice(index);

                    if (currentLevel === 1) {
                        button.innerHTML = `<img src="${choice}" alt="اختيار ${index + 1}" style="width: 70px; height: 70px; object-fit: contain; border-radius: 8px;">`;
                    } else {
                        button.innerHTML = `<span style="font-size: 50px;">${choice}</span>`;
                    }

                    answerButtons.appendChild(button);
                });

                // إظهار قسم السؤال وتفعيل الأزرار
                questionSection.classList.remove('hidden');
                setButtonsDisabled(false);
            }

            // اختيار الإجابة
            function selectChoice(choiceIndex) {
                if (!isGameRunning || buttonsDisabled) return;

                setButtonsDisabled(true);
                const feedbackElement = document.getElementById('feedback');
                const buttons = document.querySelectorAll('.choice-btn');

                if (choiceIndex === correctAnswerIndex) {
                    // إجابة صحيحة
                    buttons[choiceIndex].classList.add('correct');
                    feedbackElement.textContent = '🎉 أحسنت! إجابة صحيحة! 🎉';
                    feedbackElement.className = 'feedback correct';
                    playSuccessSound();

                    // إخفاء قسم السؤال
                    setTimeout(() => {
                        document.getElementById('question-section').classList.add('hidden');
                        proceedToNextRound();
                    }, 1500);
                } else {
                    // إجابة خاطئة
                    buttons[choiceIndex].classList.add('wrong');

                    if (correctAnswerIndex === -1) {
                        feedbackElement.textContent = `❌ لا توجد إجابة صحيحة! المحاولة ${attemptCount}`;
                    } else {
                        feedbackElement.textContent = `❌ إجابة خاطئة! المحاولة ${attemptCount}`;
                        // إظهار الإجابة الصحيحة
                        if (correctAnswerIndex >= 0) {
                            buttons[correctAnswerIndex].classList.add('correct');
                        }
                    }

                    feedbackElement.className = 'feedback incorrect';
                    playFailSound();

                    setTimeout(() => {
                        // إعادة نفس السؤال مع اختيارات أكثر
                        resetFeedback();
                        prepareTestImage();
                    }, 2500);
                }
            }

            // الانتقال للجولة التالية
            function proceedToNextRound() {
                currentRound++;

                if (currentRound > 5 || usedImages.size >= allLevelImages.size) {
                    // انتهاء المستوى
                    completeLevel();
                } else {
                    // جولة جديدة
                    startNewRound();
                }
            }

            // إكمال المستوى
            function completeLevel() {
                // مسح أي مؤقت
                if (gameTimer) {
                    clearInterval(gameTimer);
                    gameTimer = null;
                }

                document.getElementById('game-screen').classList.add('hidden');
                document.getElementById('level-complete-screen').classList.remove('hidden');

                const messageElement = document.getElementById('level-complete-message');
                const usedCount = usedImages.size;
                const totalCount = allLevelImages.size;

                messageElement.innerHTML = `
                🎉 رائع! أكملت ${gameLevels[currentLevel].name}! 🎉<br>
                <div style="font-size: 18px; margin-top: 10px;">
                    استخدمت ${usedCount} من ${totalCount} شكل مختلف! 📊
                </div>
            `;

                if (currentLevel >= 3) {
                    // إخفاء زر "المستوى التالي" في المستوى الأخير
                    document.getElementById('next-level-btn').style.display = 'none';
                    setTimeout(() => {
                        completeGame();
                    }, 2000);
                } else {
                    document.getElementById('next-level-btn').style.display = 'inline-block';
                }
            }

            // الانتقال للمستوى التالي
            function nextLevel() {
                currentLevel++;
                currentRound = 1;
                resetGameData(); // إعادة تعيين البيانات للمستوى الجديد

                if (currentLevel > 3) {
                    completeGame();
                } else {
                    document.getElementById('level-complete-screen').classList.add('hidden');
                    document.getElementById('game-screen').classList.remove('hidden');
                    startNewRound();
                }
            }

            // إكمال اللعبة
            function completeGame() {
                document.getElementById('level-complete-screen').classList.add('hidden');
                document.getElementById('game-complete-screen').classList.remove('hidden');
                isGameRunning = false;
            }

            // إعادة تشغيل اللعبة
            function restartGame() {
                // إعادة تعيين جميع المتغيرات
                currentLevel = 1;
                currentRound = 1;
                isGameRunning = false;
                buttonsDisabled = false;
                baseImageSrc = '';
                usedImages = new Set();
                allLevelImages = new Set();
                currentChoices = [];
                correctAnswerIndex = -1;
                attemptCount = 0;

                // مسح أي مؤقت
                if (gameTimer) {
                    clearInterval(gameTimer);
                    gameTimer = null;
                }

                // إظهار شاشة الترحيب
                document.getElementById('game-complete-screen').classList.add('hidden');
                document.getElementById('welcome-screen').classList.remove('hidden');

                // إعادة إظهار زر المستوى التالي
                document.getElementById('next-level-btn').style.display = 'inline-block';
            }

            // تحديث عرض اللعبة
            function updateGameDisplay() {
                document.getElementById('level-display').textContent = `المستوى ${currentLevel}`;
                document.getElementById('round-display').textContent = `الجولة ${currentRound} من 5`;
                document.getElementById('used-images-count').textContent = `الأشكال المستخدمة: ${usedImages.size}/${allLevelImages.size}`;
                document.getElementById('attempt-count').textContent = `المحاولة: ${attemptCount || 1}`;

                const progress = ((currentRound - 1) / 5) * 100;
                document.getElementById('progress-fill').style.width = progress + '%';
            }

            // إعادة تعيين الملاحظات
            function resetFeedback() {
                const feedbackElement = document.getElementById('feedback');
                feedbackElement.textContent = '';
                feedbackElement.className = 'feedback';

                // إزالة فئات التنسيق من الأزرار
                const buttons = document.querySelectorAll('.choice-btn');
                buttons.forEach((btn) => {
                    btn.classList.remove('correct', 'wrong');
                });
            }

            // تنظيف عند إغلاق الصفحة
            window.addEventListener('beforeunload', () => {
                if (gameTimer) {
                    clearInterval(gameTimer);
                }
            });
        </script>
    </body>
</html>

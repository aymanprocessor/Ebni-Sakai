<!doctype html>
<html lang="ar" dir="rtl">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>لعبة ترتيب صور القصة</title>
        <style>
            @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap');

            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: 'Amiri', serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
                min-height: 100vh;
                overflow-x: hidden;
                position: relative;
            }

            /* خلفية متحركة */
            body::before {
                content: '';
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="stars" x="0" y="0" width="20" height="20" patternUnits="userSpaceOnUse"><circle cx="10" cy="10" r="1" fill="%23ffffff" opacity="0.3"/></pattern></defs><rect width="100" height="100" fill="url(%23stars)"/></svg>')
                    repeat;
                z-index: -1;
                animation: twinkle 3s ease-in-out infinite alternate;
            }

            @keyframes twinkle {
                0% {
                    opacity: 0.5;
                }
                100% {
                    opacity: 1;
                }
            }

            .container {
                max-width: 1200px;
                margin: 0 auto;
                padding: 20px;
                position: relative;
                z-index: 1;
            }

            .header {
                text-align: center;
                margin-bottom: 30px;
                background: rgba(255, 255, 255, 0.95);
                padding: 25px;
                border-radius: 30px;
                box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
                backdrop-filter: blur(15px);
                border: 2px solid rgba(255, 255, 255, 0.3);
            }

            .title {
                font-size: 2.8rem;
                background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
                margin-bottom: 15px;
                animation: rainbow 3s ease-in-out infinite;
            }

            @keyframes rainbow {
                0%,
                100% {
                    filter: hue-rotate(0deg);
                }
                50% {
                    filter: hue-rotate(180deg);
                }
            }

            .stars-display {
                display: flex;
                justify-content: center;
                gap: 15px;
                margin: 20px 0;
            }

            .star {
                font-size: 2.5rem;
                color: #ddd;
                transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            }

            .star.earned {
                color: #ffd700;
                transform: scale(1.3);
                text-shadow: 0 0 20px #ffd700;
                animation: starGlow 1s ease-in-out;
            }

            @keyframes starGlow {
                0%,
                100% {
                    transform: scale(1.3);
                }
                50% {
                    transform: scale(1.5);
                }
            }

            .level-badge {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 12px 25px;
                border-radius: 50px;
                font-size: 1.4rem;
                font-weight: bold;
                display: inline-block;
                margin: 15px 0;
                box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
            }

            .game-area {
                background: rgba(255, 255, 255, 0.98);
                border-radius: 35px;
                padding: 35px;
                margin: 25px 0;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
                border: 3px solid rgba(255, 255, 255, 0.5);
            }

            .story-listening-phase {
                text-align: center;
                padding: 40px;
                background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
                border-radius: 25px;
                margin-bottom: 30px;
                border: 4px solid #ff9a56;
            }

            .story-title {
                font-size: 2.5rem;
                color: #ff6b6b;
                margin-bottom: 20px;
                font-weight: bold;
            }

            .story-text {
                font-size: 1.6rem;
                line-height: 2;
                color: #333;
                margin-bottom: 30px;
                padding: 20px;
                background: rgba(255, 255, 255, 0.8);
                border-radius: 15px;
            }

            .listen-controls {
                display: flex;
                justify-content: center;
                gap: 20px;
                flex-wrap: wrap;
                margin: 25px 0;
            }

            .listen-btn {
                background: linear-gradient(135deg, #667eea, #764ba2);
                color: white;
                border: none;
                padding: 15px 30px;
                border-radius: 50px;
                font-size: 1.3rem;
                cursor: pointer;
                transition: all 0.3s ease;
                font-weight: bold;
                box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
            }

            .listen-btn:hover {
                transform: translateY(-3px) scale(1.05);
                box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
            }

            .listen-btn.playing {
                background: linear-gradient(135deg, #ff6b6b, #ee5a52);
                animation: pulse 1s infinite;
            }

            @keyframes pulse {
                0%,
                100% {
                    transform: scale(1);
                }
                50% {
                    transform: scale(1.05);
                }
            }

            .images-container {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 25px;
                margin: 30px 0;
            }

            .story-card {
                background: linear-gradient(135deg, #f8f9ff 0%, #e8f4fd 100%);
                border: 4px solid #e1e8ff;
                border-radius: 25px;
                padding: 25px;
                text-align: center;
                cursor: pointer;
                transition: all 0.4s ease;
                position: relative;
                min-height: 200px;
                display: flex;
                flex-direction: column;
                justify-content: center;
            }

            .story-card:hover {
                transform: translateY(-8px) scale(1.02);
                box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
                border-color: #4ecdc4;
            }

            .story-card.selected {
                border-color: #ff6b6b;
                background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
                transform: translateY(-8px) scale(1.05);
                box-shadow: 0 12px 35px rgba(255, 107, 107, 0.3);
            }

            .story-card.correct {
                border-color: #4ecdc4;
                background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
                animation: correctPulse 0.8s ease;
            }

            @keyframes correctPulse {
                0%,
                100% {
                    transform: scale(1);
                }
                50% {
                    transform: scale(1.1);
                }
            }

            .story-emoji {
                font-size: 3.5rem;
                line-height: 1.2;
                margin-bottom: 15px;
                transition: transform 0.3s ease;
            }

            .story-card:hover .story-emoji {
                transform: scale(1.1) rotate(5deg);
            }

            .story-description {
                font-size: 1.2rem;
                color: #333;
                line-height: 1.6;
                font-weight: 600;
            }

            .order-number {
                position: absolute;
                top: -15px;
                right: -15px;
                background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
                color: white;
                width: 50px;
                height: 50px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1.5rem;
                font-weight: bold;
                opacity: 0;
                transition: all 0.5s ease;
                box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
            }

            .story-card.selected .order-number {
                opacity: 1;
                transform: scale(1.1);
            }

            .game-controls {
                display: flex;
                justify-content: center;
                gap: 20px;
                margin: 35px 0;
                flex-wrap: wrap;
            }

            .game-btn {
                background: linear-gradient(135deg, #4ecdc4, #44a08d);
                color: white;
                border: none;
                padding: 15px 30px;
                border-radius: 50px;
                font-size: 1.3rem;
                cursor: pointer;
                transition: all 0.3s ease;
                font-weight: bold;
                box-shadow: 0 6px 20px rgba(78, 205, 196, 0.3);
            }

            .game-btn:hover {
                transform: translateY(-3px) scale(1.05);
                box-shadow: 0 8px 25px rgba(78, 205, 196, 0.4);
            }

            .game-btn:disabled {
                opacity: 0.5;
                cursor: not-allowed;
                transform: none;
            }

            .btn-reset {
                background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            }

            .btn-next {
                background: linear-gradient(135deg, #667eea, #764ba2);
            }

            .feedback-area {
                text-align: center;
                font-size: 1.6rem;
                font-weight: bold;
                margin: 25px 0;
                padding: 20px;
                border-radius: 20px;
                transition: all 0.6s ease;
                min-height: 70px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .feedback-area.success {
                background: linear-gradient(135deg, #56ab2f, #a8e6cf);
                color: white;
                animation: successPulse 0.8s ease;
                box-shadow: 0 8px 25px rgba(86, 171, 47, 0.3);
            }

            .feedback-area.error {
                background: linear-gradient(135deg, #ff416c, #ff4b2b);
                color: white;
                animation: errorShake 0.6s ease;
                box-shadow: 0 8px 25px rgba(255, 65, 108, 0.3);
            }

            @keyframes successPulse {
                0%,
                100% {
                    transform: scale(1);
                }
                50% {
                    transform: scale(1.05);
                }
            }

            @keyframes errorShake {
                0%,
                100% {
                    transform: translateX(0);
                }
                25% {
                    transform: translateX(-10px);
                }
                75% {
                    transform: translateX(10px);
                }
            }

            .completion-screen {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 50px;
                border-radius: 35px;
                text-align: center;
                margin: 35px 0;
                box-shadow: 0 20px 60px rgba(102, 126, 234, 0.3);
            }

            .completion-title {
                font-size: 3rem;
                margin-bottom: 25px;
                animation: bounce 1.5s ease-in-out infinite;
            }

            @keyframes bounce {
                0%,
                20%,
                50%,
                80%,
                100% {
                    transform: translateY(0);
                }
                40% {
                    transform: translateY(-20px);
                }
                60% {
                    transform: translateY(-10px);
                }
            }

            .hidden {
                display: none;
            }

            .sound-toggle {
                position: fixed;
                top: 20px;
                left: 20px;
                background: linear-gradient(135deg, #667eea, #764ba2);
                color: white;
                border: none;
                padding: 12px;
                border-radius: 50px;
                font-size: 1.5rem;
                cursor: pointer;
                z-index: 1000;
                box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
                transition: all 0.3s ease;
            }

            .sound-toggle:hover {
                transform: scale(1.1);
            }

            .sound-toggle.muted {
                background: linear-gradient(135deg, #95a5a6, #7f8c8d);
            }

            /* تحسينات للأجهزة المحمولة */
            @media (max-width: 768px) {
                .title {
                    font-size: 2.2rem;
                }
                .images-container {
                    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                    gap: 20px;
                }
                .story-card {
                    min-height: 180px;
                }
                .story-emoji {
                    font-size: 3rem;
                }
                .game-controls,
                .listen-controls {
                    flex-direction: column;
                    align-items: center;
                }
            }

            @media (max-width: 480px) {
                .container {
                    padding: 15px;
                }
                .header {
                    padding: 20px;
                }
                .game-area {
                    padding: 25px;
                }
                .story-title {
                    font-size: 2rem;
                }
                .story-text {
                    font-size: 1.4rem;
                }
            }
        </style>
    </head>
    <body>
        <button class="sound-toggle" id="soundToggle" onclick="toggleSound()">🔊</button>

        <div class="container">
            <div class="header">
                <h1 class="title">🎭 لعبة ترتيب صور القصة 🎭</h1>
                <div class="stars-display" id="starsDisplay">
                    <span class="star">⭐</span>
                    <span class="star">⭐</span>
                    <span class="star">⭐</span>
                </div>
                <div class="level-badge" id="levelBadge">المستوى <span id="levelNumber">1</span> - القصة <span id="storyNumber">1</span></div>
            </div>

            <!-- مرحلة الاستماع للقصة -->
            <div class="story-listening-phase" id="listeningPhase">
                <h2 class="story-title" id="storyTitle">استمع للقصة</h2>
                <div class="story-text" id="storyText"></div>
                <div class="listen-controls">
                    <button class="listen-btn" id="playStoryBtn" onclick="playStory()">🎤 اسمع القصة</button>
                    <button class="listen-btn" onclick="skipToGame()">⏭️ تخطي للعبة</button>
                </div>
            </div>

            <div class="game-area" id="gameArea">
                <div class="images-container" id="imagesContainer">
                    <!-- الصور ستظهر هنا -->
                </div>

                <div class="game-controls">
                    <button class="game-btn btn-reset" onclick="resetGame()">🔄 إعادة ترتيب</button>
                    <button class="game-btn btn-next hidden" id="nextButton" onclick="nextStory()">⏭️ القصة التالية</button>
                </div>

                <div class="feedback-area" id="feedbackArea"></div>
            </div>

            <div class="completion-screen hidden" id="completionScreen">
                <h2 class="completion-title">🎉 مبروك يا بطل! 🎉</h2>
                <p style="font-size: 1.8rem; margin-bottom: 30px">لقد أتممت جميع القصص بنجاح!</p>
                <div class="stars-display">
                    <span class="star earned">⭐</span>
                    <span class="star earned">⭐</span>
                    <span class="star earned">⭐</span>
                </div>
                <button class="game-btn" onclick="restartGame()">🎮 العب مرة أخرى</button>
            </div>
        </div>

        <script>
            // بيانات اللعبة
            const gameData = {
                currentLevel: 1,
                currentStory: 0,
                selectedOrder: [],
                earnedStars: 0,
                soundEnabled: true,
                speechSynth: window.speechSynthesis,
                gamePhase: 'listening' // listening, playing, completed
            };

            // قصص اللعبة المحسنة
            const stories = {
                1: [
                    // المستوى الأول - 3 صور
                    {
                        title: 'القطة الصغيرة والحليب',
                        story: 'في الصباح الباكر، وضعت الأم كوب حليب أبيض لذيذ على الطاولة البنية. رأت القطة الصغيرة الجميلة كوب الحليب، فاقتربت منه بحماس شديد. شربت القطة كل الحليب بسعادة وأصبحت راضية ومبتسمة!',
                        images: [
                            {
                                visual: '🟫<br/>🥛',
                                description: 'كوب حليب أبيض على الطاولة البنية',
                                order: 1
                            },
                            {
                                visual: '🐱 ➡️ 🥛',
                                description: 'القطة تمشي نحو كوب الحليب',
                                order: 2
                            },
                            {
                                visual: '😺<br/>💕',
                                description: 'القطة سعيدة بعد شرب الحليب',
                                order: 3
                            }
                        ]
                    },
                    {
                        title: 'الطفل وتنظيف الأسنان',
                        story: 'استيقظ أحمد من نومه العميق في صباح جميل. ذهب إلى الحمام وأخذ فرشاة أسنانه ووضع عليها معجون الأسنان الأبيض. نظف أسنانه جيداً وأصبحت بيضاء ولامعة مثل اللؤلؤ!',
                        images: [
                            {
                                visual: '👦<br/>🛏️',
                                description: 'الطفل يستيقظ من السرير',
                                order: 1
                            },
                            {
                                visual: '👦<br/>🪥',
                                description: 'الطفل يستخدم فرشاة الأسنان',
                                order: 2
                            },
                            {
                                visual: '👦<br/>✨😁',
                                description: 'الطفل يبتسم بأسنان نظيفة',
                                order: 3
                            }
                        ]
                    },
                    {
                        title: 'الأرنب والجزرة',
                        story: 'في حديقة خضراء جميلة، كانت تنمو جزرة برتقالية كبيرة في الأرض. شاهد الأرنب الأبيض الصغير الجزرة الشهية من بعيد. قفز الأرنب بفرح وأكل الجزرة اللذيذة بشهية عالية!',
                        images: [
                            {
                                visual: '🌱<br/>🥕',
                                description: 'جزرة تنمو في الأرض',
                                order: 1
                            },
                            {
                                visual: '🐰 👁️<br/>🥕',
                                description: 'الأرنب يرى الجزرة',
                                order: 2
                            },
                            {
                                visual: '🐰<br/>😋🥕',
                                description: 'الأرنب يأكل الجزرة بسعادة',
                                order: 3
                            }
                        ]
                    }
                ],
                2: [
                    // المستوى الثاني - 4 صور
                    {
                        title: 'رحلة الفراشة الجميلة',
                        story: 'كانت هناك يرقة صغيرة خضراء تزحف على الأوراق. لفت اليرقة نفسها في شرنقة حريرية دافئة ونامت بهدوء. بعد أيام قليلة، خرجت من الشرنقة فراشة جميلة بألوان زاهية. طارت الفراشة بسعادة بين الزهور الملونة في الحديقة!',
                        images: [
                            {
                                visual: '🐛<br/>🍃',
                                description: 'يرقة خضراء على الأوراق',
                                order: 1
                            },
                            {
                                visual: '🛡️<br/>😴',
                                description: 'الشرنقة تنام بهدوء',
                                order: 2
                            },
                            {
                                visual: '🦋<br/>✨',
                                description: 'فراشة جميلة تخرج من الشرنقة',
                                order: 3
                            },
                            {
                                visual: '🦋<br/>🌺🌸',
                                description: 'الفراشة تطير بين الزهور',
                                order: 4
                            }
                        ]
                    },
                    {
                        title: 'صنع الكعكة اللذيذة',
                        story: 'جمعت الأم الحنون جميع المكونات: الدقيق والسكر والبيض والزبدة. خلطت كل المكونات في وعاء كبير حتى أصبحت عجينة ناعمة. وضعت العجينة في الفرن الساخن وانتظرت حتى تنضج. خرجت كعكة ذهبية عطرة، واجتمعت العائلة لتناولها بفرح!',
                        images: [
                            {
                                visual: '👩‍🍳<br/>🥄🍚',
                                description: 'الأم تجمع المكونات',
                                order: 1
                            },
                            {
                                visual: '👩‍🍳🥣<br/>🌀',
                                description: 'خلط المكونات في الوعاء',
                                order: 2
                            },
                            {
                                visual: '🔥🍰<br/>⏰',
                                description: 'وضع العجينة في الفرن',
                                order: 3
                            },
                            {
                                visual: '👨‍👩‍👧‍👦<br/>🍰😋',
                                description: 'العائلة تتناول الكعكة معاً',
                                order: 4
                            }
                        ]
                    }
                ],
                3: [
                    // المستوى الثالث - 5 صور
                    {
                        title: 'رحلة البذرة إلى الزهرة',
                        story: 'زرع المزارع بذرة صغيرة في التربة الخصبة. سقى البذرة بالماء العذب تحت أشعة الشمس الدافئة كل يوم. بدأت البذرة بالإنبات وظهرت برعم أخضر صغير. نمت النبتة يوماً بعد يوم وأصبحت أطول وأقوى. أخيراً، تفتحت زهرة جميلة ملونة تنشر عطرها في كل مكان!',
                        images: [
                            {
                                visual: '🟤<br/>🌱',
                                description: 'بذرة صغيرة في التربة',
                                order: 1
                            },
                            {
                                visual: '☀️💧<br/>🌱',
                                description: 'سقي البذرة تحت الشمس',
                                order: 2
                            },
                            {
                                visual: '🌿<br/>⬆️',
                                description: 'البرعم الأخضر ينمو',
                                order: 3
                            },
                            {
                                visual: '🌿<br/>📏',
                                description: 'النبتة تصبح أطول',
                                order: 4
                            },
                            {
                                visual: '🌸<br/>🌺',
                                description: 'الزهرة الجميلة تتفتح',
                                order: 5
                            }
                        ]
                    }
                ]
            };

            // دوال اللعبة الأساسية
            function initGame() {
                updateUI();
                showListeningPhase();
            }

            function updateUI() {
                document.getElementById('levelNumber').textContent = gameData.currentLevel;
                document.getElementById('storyNumber').textContent = gameData.currentStory + 1;
                updateStarsDisplay();
            }

            function showListeningPhase() {
                const story = getCurrentStory();
                gameData.gamePhase = 'listening';

                document.getElementById('storyTitle').textContent = story.title;
                document.getElementById('storyText').textContent = story.story;

                document.getElementById('listeningPhase').classList.remove('hidden');
                document.getElementById('gameArea').classList.add('hidden');

                // قراءة القصة تلقائياً إذا كان الصوت مفعلاً
                if (gameData.soundEnabled) {
                    setTimeout(() => {
                        playStory();
                    }, 1000);
                }
            }

            function getCurrentStory() {
                return stories[gameData.currentLevel][gameData.currentStory];
            }

            function playStory() {
                const story = getCurrentStory();
                const playBtn = document.getElementById('playStoryBtn');

                if (gameData.soundEnabled) {
                    playBtn.classList.add('playing');
                    playBtn.textContent = '🔊 يتم تشغيل القصة...';

                    speakText(`استمع جيداً للقصة: ${story.story}`, () => {
                        playBtn.classList.remove('playing');
                        playBtn.textContent = '🔄 أعد تشغيل القصة';

                        // انتقل للعبة تلقائياً بعد انتهاء القصة
                        setTimeout(() => {
                            startGamePhase();
                        }, 2000);
                    });
                }
            }

            function skipToGame() {
                // إيقاف أي صوت جاري
                if (gameData.speechSynth) {
                    gameData.speechSynth.cancel();
                }
                startGamePhase();
            }

            function startGamePhase() {
                gameData.gamePhase = 'playing';
                document.getElementById('listeningPhase').classList.add('hidden');
                document.getElementById('gameArea').classList.remove('hidden');

                displayStoryCards();

                if (gameData.soundEnabled) {
                    speakText('الآن رتب الصور حسب تسلسل أحداث القصة التي سمعتها');
                }
            }

            function displayStoryCards() {
                const story = getCurrentStory();
                const imagesContainer = document.getElementById('imagesContainer');
                imagesContainer.innerHTML = '';

                // مسح التحديد السابق
                gameData.selectedOrder = [];

                // خلط الصور عشوائياً
                const shuffledImages = [...story.images].sort(() => Math.random() - 0.5);

                shuffledImages.forEach((image) => {
                    const card = document.createElement('div');
                    card.className = 'story-card';
                    card.innerHTML = `
                    <div class="story-emoji">${image.visual}</div>
                    <div class="story-description">${image.description}</div>
                    <div class="order-number"></div>
                `;

                    card.onclick = () => selectImage(card, image.order);
                    imagesContainer.appendChild(card);
                });

                // إخفاء العناصر غير المطلوبة
                document.getElementById('nextButton').classList.add('hidden');
                document.getElementById('feedbackArea').textContent = '';
                document.getElementById('feedbackArea').className = 'feedback-area';
            }

            function selectImage(cardElement, order) {
                const orderIndex = gameData.selectedOrder.indexOf(order);

                if (orderIndex !== -1) {
                    // إلغاء التحديد
                    gameData.selectedOrder.splice(orderIndex, 1);
                    cardElement.classList.remove('selected');
                    cardElement.querySelector('.order-number').textContent = '';
                } else {
                    // إضافة التحديد
                    gameData.selectedOrder.push(order);
                    cardElement.classList.add('selected');
                }

                // تحديث أرقام الترتيب
                updateOrderNumbers();

                // التحقق التلقائي من الإجابة
                autoCheckAnswer();
            }

            function updateOrderNumbers() {
                const selectedCards = document.querySelectorAll('.story-card.selected');
                selectedCards.forEach((card, index) => {
                    const orderNumber = card.querySelector('.order-number');
                    const cardOrder = gameData.selectedOrder[index];
                    const displayIndex = gameData.selectedOrder.indexOf(cardOrder) + 1;
                    orderNumber.textContent = displayIndex;
                });
            }

            function autoCheckAnswer() {
                const story = getCurrentStory();

                // التحقق فقط إذا تم اختيار جميع الصور
                if (gameData.selectedOrder.length !== story.images.length) {
                    return;
                }

                const correctOrder = story.images.map((img) => img.order).sort((a, b) => a - b);
                const isCorrect = JSON.stringify(gameData.selectedOrder) === JSON.stringify(correctOrder);

                const feedbackArea = document.getElementById('feedbackArea');

                if (isCorrect) {
                    // إجابة صحيحة
                    feedbackArea.textContent = '🎉 ممتاز! ترتيب صحيح! 🎉';
                    feedbackArea.className = 'feedback-area success';

                    // تلوين الكروت بالأخضر
                    const cards = document.querySelectorAll('.story-card.selected');
                    cards.forEach((card) => {
                        card.classList.add('correct');
                    });

                    gameData.earnedStars++;
                    updateStarsDisplay();
                    playSuccessSound();

                    // إظهار زر القصة التالية بعد قليل
                    setTimeout(() => {
                        document.getElementById('nextButton').classList.remove('hidden');
                        if (gameData.soundEnabled) {
                            speakText('أحسنت! لقد رتبت القصة بالشكل الصحيح تماماً!');
                        }
                    }, 1000);
                } else {
                    // إجابة خاطئة
                    feedbackArea.textContent = '❌ ترتيب خاطئ! حاول مرة أخرى 🤔';
                    feedbackArea.className = 'feedback-area error';
                    playErrorSound();

                    if (gameData.soundEnabled) {
                        speakText('الترتيب ليس صحيحاً. فكر مرة أخرى في تسلسل الأحداث');
                    }

                    // إعادة تعيين تلقائي بعد ثانيتين
                    setTimeout(() => {
                        resetGame();
                    }, 2000);
                }
            }

            function resetGame() {
                gameData.selectedOrder = [];
                const cards = document.querySelectorAll('.story-card');
                cards.forEach((card) => {
                    card.classList.remove('selected', 'correct');
                    card.querySelector('.order-number').textContent = '';
                });

                document.getElementById('feedbackArea').textContent = '';
                document.getElementById('feedbackArea').className = 'feedback-area';
            }

            function nextStory() {
                gameData.currentStory++;

                if (gameData.currentStory >= stories[gameData.currentLevel].length) {
                    // الانتقال للمستوى التالي
                    gameData.currentLevel++;
                    gameData.currentStory = 0;

                    if (gameData.currentLevel > 3) {
                        // انتهاء اللعبة
                        showCompletionScreen();
                        return;
                    }

                    if (gameData.soundEnabled) {
                        speakText(`ممتاز! انتقلت للمستوى ${gameData.currentLevel}!`);
                    }
                }

                updateUI();
                showListeningPhase();
            }

            function showCompletionScreen() {
                document.getElementById('gameArea').classList.add('hidden');
                document.getElementById('listeningPhase').classList.add('hidden');
                document.getElementById('completionScreen').classList.remove('hidden');

                if (gameData.soundEnabled) {
                    setTimeout(() => {
                        speakText('مبروك! لقد أتممت جميع القصص بنجاح! أنت بطل حقيقي!');
                    }, 1000);
                }
            }

            function restartGame() {
                // إعادة تعيين جميع البيانات
                gameData.currentLevel = 1;
                gameData.currentStory = 0;
                gameData.selectedOrder = [];
                gameData.earnedStars = 0;
                gameData.gamePhase = 'listening';

                // إخفاء شاشة الإكمال
                document.getElementById('completionScreen').classList.add('hidden');

                // تحديث النجوم والبدء من جديد
                updateUI();
                showListeningPhase();

                if (gameData.soundEnabled) {
                    speakText('مرحباً مرة أخرى! لنبدأ رحلة جديدة مع القصص!');
                }
            }

            function updateStarsDisplay() {
                const stars = document.querySelectorAll('#starsDisplay .star');
                stars.forEach((star, index) => {
                    if (index < gameData.earnedStars) {
                        star.classList.add('earned');
                    } else {
                        star.classList.remove('earned');
                    }
                });
            }

            // دوال الصوت والنطق
            function toggleSound() {
                gameData.soundEnabled = !gameData.soundEnabled;
                const button = document.getElementById('soundToggle');

                if (gameData.soundEnabled) {
                    button.textContent = '🔊';
                    button.classList.remove('muted');
                    setTimeout(() => speakText('تم تشغيل الصوت'), 300);
                } else {
                    button.textContent = '🔇';
                    button.classList.add('muted');
                    // إيقاف أي صوت جاري
                    if (gameData.speechSynth) {
                        gameData.speechSynth.cancel();
                    }
                }
            }

            function speakText(text, callback = null, rate = 0.8) {
                if (!gameData.soundEnabled || !gameData.speechSynth) {
                    if (callback) callback();
                    return;
                }

                // إيقاف أي كلام جاري
                gameData.speechSynth.cancel();

                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'ar-SA';
                utterance.rate = rate;
                utterance.pitch = 1.1;
                utterance.volume = 0.9;

                // البحث عن صوت عربي
                const voices = gameData.speechSynth.getVoices();
                const arabicVoice = voices.find((voice) => voice.lang.startsWith('ar') || voice.name.includes('Arabic') || voice.name.includes('عربي'));

                if (arabicVoice) {
                    utterance.voice = arabicVoice;
                }

                if (callback) {
                    utterance.onend = callback;
                }

                gameData.speechSynth.speak(utterance);
            }

            // دوال الأصوات التفاعلية
            function playSuccessSound() {
                if (!gameData.soundEnabled) return;

                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const frequencies = [523.25, 659.25, 783.99]; // C5, E5, G5

                    frequencies.forEach((freq, index) => {
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();

                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);

                        oscillator.frequency.setValueAtTime(freq, audioContext.currentTime + index * 0.15);
                        oscillator.type = 'sine';

                        gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.8);

                        oscillator.start(audioContext.currentTime + index * 0.15);
                        oscillator.stop(audioContext.currentTime + index * 0.15 + 0.8);
                    });
                } catch (error) {
                    console.log('Audio context not supported');
                }
            }

            function playErrorSound() {
                if (!gameData.soundEnabled) return;

                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();

                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);

                    oscillator.frequency.setValueAtTime(220, audioContext.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(150, audioContext.currentTime + 0.4);
                    oscillator.type = 'sawtooth';

                    gainNode.gain.setValueAtTime(0.15, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.4);

                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.4);
                } catch (error) {
                    console.log('Audio context not supported');
                }
            }

            // تشغيل اللعبة عند تحميل الصفحة
            window.addEventListener('load', () => {
                // تحميل الأصوات المتاحة
                if (gameData.speechSynth && 'onvoiceschanged' in gameData.speechSynth) {
                    gameData.speechSynth.onvoiceschanged = () => {
                        console.log('الأصوات متاحة:', gameData.speechSynth.getVoices().length);
                    };
                }

                // بدء اللعبة
                setTimeout(() => {
                    initGame();
                    if (gameData.soundEnabled) {
                        speakText('أهلاً وسهلاً! مرحباً بك في لعبة ترتيب صور القصة!');
                    }
                }, 500);
            });
        </script>
    </body>
</html>

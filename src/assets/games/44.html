<!doctype html>
<html lang="ar" dir="rtl">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>لعبة التصفيق للمقاطع</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                color: #333;
                font-size: 20px;
                overflow-x: hidden;
            }

            .container {
                max-width: 900px;
                margin: 0 auto;
                padding: 20px;
                min-height: 100vh;
                display: flex;
                flex-direction: column;
                justify-content: center;
            }

            .game-header {
                text-align: center;
                margin-bottom: 30px;
                background: rgba(255, 255, 255, 0.95);
                padding: 25px;
                border-radius: 20px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
                backdrop-filter: blur(10px);
            }

            .game-title {
                font-size: 2.5em;
                color: #5a67d8;
                margin-bottom: 10px;
                font-weight: bold;
                text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
            }

            .game-subtitle {
                font-size: 1.2em;
                color: #666;
                line-height: 1.4;
            }

            .level-selection,
            .game-area,
            .results-screen {
                background: rgba(255, 255, 255, 0.95);
                padding: 30px;
                border-radius: 20px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
                text-align: center;
                display: none;
                backdrop-filter: blur(10px);
                position: relative;
            }

            .level-selection.active,
            .game-area.active,
            .results-screen.active {
                display: block;
            }

            .level-description {
                font-size: 1.1em;
                color: #4a5568;
                margin-bottom: 25px;
                line-height: 1.5;
            }

            .level-buttons {
                display: flex;
                flex-direction: column;
                gap: 20px;
                margin-top: 30px;
                max-width: 500px;
                margin-left: auto;
                margin-right: auto;
            }

            .level-btn {
                padding: 25px 30px;
                font-size: 1.3em;
                background: linear-gradient(45deg, #4facfe, #00f2fe);
                color: white;
                border: none;
                border-radius: 15px;
                cursor: pointer;
                transition: all 0.3s ease;
                font-weight: bold;
                position: relative;
                overflow: hidden;
                line-height: 1.4;
            }

            .level-btn:hover {
                transform: translateY(-3px);
                box-shadow: 0 15px 30px rgba(79, 172, 254, 0.4);
            }

            .level-btn:focus {
                outline: 3px solid #ffd700;
                outline-offset: 2px;
            }

            .level-btn:active {
                transform: translateY(0);
            }

            .word-display {
                margin: 30px 0;
                text-align: center;
                background: rgba(247, 250, 252, 0.8);
                padding: 25px;
                border-radius: 15px;
                border: 2px solid rgba(203, 213, 224, 0.5);
            }

            .word-emoji {
                font-size: 4em;
                margin-bottom: 15px;
                display: block;
                text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
            }

            .word-text {
                font-size: 2.8em;
                font-weight: bold;
                color: #2d3748;
                margin-bottom: 15px;
                text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
            }

            .word-segments {
                font-size: 1.8em;
                color: #4a5568;
                letter-spacing: 5px;
                margin-bottom: 20px;
                background: rgba(255, 255, 255, 0.7);
                padding: 15px;
                border-radius: 10px;
                border: 2px dashed #cbd5e0;
                font-weight: 600;
            }

            .question-text {
                font-size: 1.5em;
                color: #2d3748;
                margin: 25px 0;
                font-weight: bold;
                line-height: 1.4;
            }

            .answer-buttons {
                display: flex;
                justify-content: center;
                gap: 40px;
                margin: 40px 0;
                flex-wrap: wrap;
            }

            .answer-btn {
                width: 90px;
                height: 90px;
                font-size: 2.2em;
                font-weight: bold;
                border: none;
                border-radius: 50%;
                cursor: pointer;
                transition: all 0.3s ease;
                background: linear-gradient(45deg, #ff6b6b, #ffa07a);
                color: white;
                box-shadow: 0 8px 20px rgba(255, 107, 107, 0.3);
                position: relative;
            }

            .answer-btn:hover {
                transform: scale(1.15);
                box-shadow: 0 12px 30px rgba(255, 107, 107, 0.4);
            }

            .answer-btn:focus {
                outline: 3px solid #ffd700;
                outline-offset: 3px;
            }

            .answer-btn:active {
                transform: scale(1.05);
            }

            .answer-btn:disabled {
                opacity: 0.6;
                cursor: not-allowed;
                transform: none;
            }

            .control-buttons {
                display: flex;
                justify-content: center;
                gap: 20px;
                margin: 25px 0;
                flex-wrap: wrap;
            }

            .control-btn {
                padding: 15px 25px;
                font-size: 1.1em;
                border: none;
                border-radius: 12px;
                cursor: pointer;
                transition: all 0.3s ease;
                background: #48bb78;
                color: white;
                font-weight: bold;
                min-width: 140px;
            }

            .control-btn:hover {
                background: #38a169;
                transform: translateY(-2px);
                box-shadow: 0 8px 20px rgba(72, 187, 120, 0.3);
            }

            .control-btn:focus {
                outline: 3px solid #ffd700;
                outline-offset: 2px;
            }

            .control-btn:disabled {
                opacity: 0.6;
                cursor: not-allowed;
                transform: none;
            }

            .progress-area {
                margin: 25px 0;
                text-align: center;
                background: rgba(247, 250, 252, 0.8);
                padding: 20px;
                border-radius: 15px;
            }

            .progress-bar {
                width: 100%;
                height: 25px;
                background: #e2e8f0;
                border-radius: 15px;
                overflow: hidden;
                margin: 15px 0;
                box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
            }

            .progress-fill {
                height: 100%;
                background: linear-gradient(45deg, #48bb78, #68d391);
                width: 0%;
                transition: width 0.6s ease;
                border-radius: 15px;
            }

            .score-display {
                font-size: 1.4em;
                font-weight: bold;
                color: #2d3748;
                margin: 15px 0;
            }

            .feedback-message {
                font-size: 1.4em;
                font-weight: bold;
                margin: 25px 0;
                padding: 20px;
                border-radius: 15px;
                min-height: 70px;
                display: flex;
                align-items: center;
                justify-content: center;
                line-height: 1.4;
                text-align: center;
            }

            .feedback-correct {
                background: linear-gradient(45deg, #c6f6d5, #9ae6b4);
                color: #22543d;
                border: 3px solid #48bb78;
                box-shadow: 0 5px 15px rgba(72, 187, 120, 0.3);
            }

            .feedback-incorrect {
                background: linear-gradient(45deg, #fed7d7, #fbb6ce);
                color: #742a2a;
                border: 3px solid #e53e3e;
                box-shadow: 0 5px 15px rgba(229, 62, 62, 0.3);
            }

            .feedback-hint {
                background: linear-gradient(45deg, #fef5e7, #fbd38d);
                color: #744210;
                border: 3px solid #ed8936;
                box-shadow: 0 5px 15px rgba(237, 137, 54, 0.3);
            }

            .hint-text {
                font-size: 1.3em;
                color: #4a5568;
                margin: 20px 0;
                font-style: italic;
                background: rgba(255, 255, 255, 0.8);
                padding: 15px;
                border-radius: 10px;
                border-left: 4px solid #ed8936;
            }

            .celebration {
                animation: bounce 0.8s ease-in-out;
            }

            @keyframes bounce {
                0%,
                20%,
                60%,
                100% {
                    transform: translateY(0) scale(1);
                }
                40% {
                    transform: translateY(-25px) scale(1.05);
                }
                80% {
                    transform: translateY(-15px) scale(1.02);
                }
            }

            .pulse {
                animation: pulse 1.5s infinite;
            }

            @keyframes pulse {
                0% {
                    transform: scale(1);
                }
                50% {
                    transform: scale(1.08);
                }
                100% {
                    transform: scale(1);
                }
            }

            .hidden {
                display: none !important;
            }

            .back-btn {
                position: absolute;
                top: 15px;
                left: 15px;
                padding: 12px 20px;
                background: #718096;
                color: white;
                border: none;
                border-radius: 10px;
                cursor: pointer;
                font-size: 1em;
                font-weight: bold;
                transition: all 0.3s ease;
            }

            .back-btn:hover {
                background: #4a5568;
                transform: translateY(-2px);
            }

            .back-btn:focus {
                outline: 3px solid #ffd700;
            }

            .loading {
                opacity: 0.7;
                pointer-events: none;
            }

            .final-score {
                font-size: 1.6em;
                line-height: 1.5;
                margin: 25px 0;
                color: #2d3748;
            }

            .results-emoji {
                font-size: 3em;
                margin: 20px 0;
                display: block;
            }

            @media (max-width: 768px) {
                .container {
                    padding: 15px;
                }

                .game-title {
                    font-size: 2em;
                }

                .word-text {
                    font-size: 2.2em;
                }

                .word-segments {
                    font-size: 1.5em;
                    letter-spacing: 3px;
                }

                .answer-buttons {
                    gap: 25px;
                }

                .answer-btn {
                    width: 75px;
                    height: 75px;
                    font-size: 1.8em;
                }

                .control-buttons {
                    flex-direction: column;
                    align-items: center;
                }

                .control-btn {
                    min-width: 200px;
                }

                .back-btn {
                    position: relative;
                    top: 0;
                    left: 0;
                    margin-bottom: 20px;
                }
            }

            @media (max-width: 480px) {
                .game-header,
                .level-selection,
                .game-area,
                .results-screen {
                    padding: 20px;
                }

                .word-emoji {
                    font-size: 3em;
                }

                .word-text {
                    font-size: 1.8em;
                }

                .answer-btn {
                    width: 65px;
                    height: 65px;
                    font-size: 1.6em;
                }
            }

            /* تحسينات الوصول */
            .sr-only {
                position: absolute;
                width: 1px;
                height: 1px;
                padding: 0;
                margin: -1px;
                overflow: hidden;
                clip: rect(0, 0, 0, 0);
                white-space: nowrap;
                border: 0;
            }

            /* تأثيرات بصرية للنجاح */
            .success-glow {
                animation: successGlow 1s ease-in-out;
            }

            @keyframes successGlow {
                0% {
                    box-shadow: 0 0 5px rgba(72, 187, 120, 0.5);
                }
                50% {
                    box-shadow:
                        0 0 20px rgba(72, 187, 120, 0.8),
                        0 0 30px rgba(72, 187, 120, 0.6);
                }
                100% {
                    box-shadow: 0 0 5px rgba(72, 187, 120, 0.5);
                }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="game-header">
                <h1 class="game-title">🎵 لعبة التصفيق للمقاطع 🎵</h1>
                <p class="game-subtitle">استمع للكلمة مقطعة ببطء، ثم صفق معها واختر عدد المقاطع!</p>
            </div>

            <!-- Level Selection Screen -->
            <div class="level-selection active" id="levelSelection">
                <h2>اختر المستوى المناسب</h2>
                <p class="level-description">ستسمع 10 كلمات في كل مستوى. استمع جيداً وصفق مع كل مقطع!</p>
                <div class="level-buttons">
                    <button class="level-btn" onclick="startLevel(1)" aria-label="المستوى الأول - كلمات من مقطعين">
                        المستوى 1: مقطعان
                        <br /><small>كلمات قصيرة ومألوفة مثل: ماما، قلم، كرة</small>
                    </button>
                    <button class="level-btn" onclick="startLevel(2)" aria-label="المستوى الثاني - كلمات من ثلاثة مقاطع">
                        المستوى 2: ثلاثة مقاطع
                        <br /><small>كلمات أطول مثل: مدرسة، تفاحة، سيارة</small>
                    </button>
                    <button class="level-btn" onclick="startLevel(3)" aria-label="المستوى الثالث - مزيج من المقطعين والثلاثة">
                        المستوى 3: التحدي
                        <br /><small>مزيج من المقطعين والثلاثة معاً</small>
                    </button>
                </div>
            </div>

            <!-- Game Area -->
            <div class="game-area" id="gameArea">
                <button class="back-btn" onclick="goToLevelSelection()" aria-label="العودة لاختيار المستوى">← العودة</button>

                <div class="progress-area">
                    <div class="score-display" id="scoreDisplay">السؤال: 1/10 | النقاط: 0</div>
                    <div class="progress-bar" role="progressbar" aria-label="تقدم اللعبة">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                </div>

                <div class="word-display">
                    <span class="word-emoji" id="wordEmoji" aria-hidden="true">🎯</span>
                    <div class="word-text" id="wordText">جاري التحميل...</div>
                    <div class="word-segments hidden" id="wordSegments" aria-label="تقسيم المقاطع"></div>
                </div>

                <div class="question-text" id="questionText">استمع للكلمة... صفق مع كل مقطع... كم مقطعاً سمعت؟</div>

                <div class="answer-buttons" id="answerButtons">
                    <button class="answer-btn" onclick="checkAnswer(2)" aria-label="مقطعان" data-answer="2">2</button>
                    <button class="answer-btn" onclick="checkAnswer(3)" aria-label="ثلاثة مقاطع" data-answer="3">3</button>
                </div>

                <div class="control-buttons">
                    <button class="control-btn" id="listenBtn" onclick="speakWord()" aria-label="أعد الاستماع للكلمة">🔊 أعد الاستماع</button>
                    <button class="control-btn" onclick="showHint()" aria-label="اطلب تلميحاً">💡 تلميح</button>
                </div>

                <div class="feedback-message hidden" id="feedbackMessage" role="status" aria-live="polite" aria-atomic="true"></div>
                <div class="hint-text hidden" id="hintText"></div>
            </div>

            <!-- Results Screen -->
            <div class="results-screen" id="resultsScreen">
                <span class="results-emoji" id="resultsEmoji">🎉</span>
                <h2>انتهت اللعبة!</h2>
                <div class="final-score" id="finalScore">النتيجة النهائية</div>
                <div class="control-buttons">
                    <button class="control-btn" onclick="restartGame()" aria-label="إعادة لعب نفس المستوى">🔄 إعادة اللعب</button>
                    <button class="control-btn" onclick="goToLevelSelection()" aria-label="العودة لاختيار مستوى آخر">📚 مستوى آخر</button>
                </div>
            </div>
        </div>

        <script>
            // Game Data - Fixed syllable segmentation
            const LEVEL1 = [
                { word: 'ماما', syllables: 2, segments: 'ما . . ما', hint: 'أمي الحبيبة', emoji: '👩' },
                { word: 'بابا', syllables: 2, segments: 'با . . با', hint: 'أبي العزيز', emoji: '👨' },
                { word: 'كرسي', syllables: 2, segments: 'كر . . سي', hint: 'نجلس عليه في الفصل', emoji: '🪑' },
                { word: 'قلم', syllables: 2, segments: 'قـَ . . لم', hint: 'نكتب ونرسم به', emoji: '✏️' },
                { word: 'شنطة', syllables: 2, segments: 'شن . . طة', hint: 'نحمل فيها الكتب', emoji: '🎒' },
                { word: 'لمبة', syllables: 2, segments: 'لم . . بة', hint: 'تضيء الغرفة', emoji: '💡' },
                { word: 'كرة', syllables: 2, segments: 'كـُ . . رة', hint: 'نلعب بها كرة القدم', emoji: '⚽' },
                { word: 'شباك', syllables: 2, segments: 'شبا . . ك', hint: 'ننظر منه للحديقة', emoji: '🪟' },
                { word: 'قطة', syllables: 2, segments: 'قـِ . . طة', hint: 'حيوان أليف يموء', emoji: '🐱' },
                { word: 'بطة', syllables: 2, segments: 'بـَ . . طة', hint: 'تسبح في البركة', emoji: '🦆' },
                { word: 'موزة', syllables: 2, segments: 'مو . . زة', hint: 'فاكهة صفراء طويلة', emoji: '🍌' },
                { word: 'جبنة', syllables: 2, segments: 'جب . . نة', hint: 'طعام أبيض من الحليب', emoji: '🧀' },
                { word: 'بيضة', syllables: 2, segments: 'بي . . ضة', hint: 'نأكلها في الفطار', emoji: '🥚' },
                { word: 'دفتر', syllables: 2, segments: 'دف . . تر', hint: 'نكتب فيه الواجبات', emoji: '📒' },
                { word: 'سلمى', syllables: 2, segments: 'سل . . مى', hint: 'اسم فتاة جميل', emoji: '👧' },
                { word: 'نجمة', syllables: 2, segments: 'نج . . مة', hint: 'تضيء في السماء ليلاً', emoji: '⭐' },
                { word: 'وردة', syllables: 2, segments: 'ور . . دة', hint: 'زهرة جميلة ورائحتها طيبة', emoji: '🌹' },
                { word: 'جبل', syllables: 2, segments: 'جـَ . . بل', hint: 'مرتفع عالي من الأرض', emoji: '⛰️' }
            ];

            const LEVEL2 = [
                { word: 'مدرسة', syllables: 3, segments: 'مد . . رس . . ة', hint: 'نتعلم فيها العلوم والرياضيات', emoji: '🏫' },
                { word: 'مكتبة', syllables: 3, segments: 'مك . . تـَ . . بة', hint: 'نقرأ فيها الكتب', emoji: '📚' },
                { word: 'مدينة', syllables: 3, segments: 'مد . . ي . . نة', hint: 'مكان كبير للسكن', emoji: '🏙️' },
                { word: 'حديقة', syllables: 3, segments: 'حد . . ي . . قة', hint: 'مكان الأشجار والورود', emoji: '🌳' },
                { word: 'سيارة', syllables: 3, segments: 'سي . . يا . . رة', hint: 'تنقلنا من مكان لآخر', emoji: '🚗' },
                { word: 'طيارة', syllables: 3, segments: 'طي . . يا . . رة', hint: 'تطير عالياً في السماء', emoji: '✈️' },
                { word: 'مستشفى', syllables: 3, segments: 'مس . . تش . . فى', hint: 'نذهب إليها للعلاج', emoji: '🏥' },
                { word: 'مكنسة', syllables: 3, segments: 'مك . . نس . . ة', hint: 'ننظف بها الأرض', emoji: '🧹' },
                { word: 'ثلاجة', syllables: 3, segments: 'ثلا . . ج . . ة', hint: 'تحفظ الطعام بارداً', emoji: '❄️' },
                { word: 'مقلمة', syllables: 3, segments: 'مق . . لـَ . . مة', hint: 'نضع فيها الأقلام', emoji: '📝' },
                { word: 'مسطرة', syllables: 3, segments: 'مس . . طـَ . . رة', hint: 'نرسم بها خطوط مستقيمة', emoji: '📏' },
                { word: 'شمسية', syllables: 3, segments: 'شم . . سي . . ة', hint: 'تحمينا من الشمس والمطر', emoji: '☂️' },
                { word: 'تفاحة', syllables: 3, segments: 'تف . . فا . . حة', hint: 'فاكهة حمراء مفيدة', emoji: '🍎' },
                { word: 'طماطم', syllables: 3, segments: 'طـَ . . ما . . طم', hint: 'خضار حمراء للسلطة', emoji: '🍅' },
                { word: 'فراولة', syllables: 3, segments: 'فـَ . . راو . . لة', hint: 'فاكهة حمراء صغيرة حلوة', emoji: '🍓' },
                { word: 'زرافة', syllables: 3, segments: 'زَ . . را . . فة', hint: 'حيوان طويل الرقبة', emoji: '🦒' },
                { word: 'فراشة', syllables: 3, segments: 'فـَ . . را . . شة', hint: 'حشرة ملونة تطير', emoji: '🦋' }
            ];

            // Game State
            let currentLevel = 1;
            let currentQuestionIndex = 0;
            let currentQuestions = [];
            let score = 0;
            let attempts = 0;
            let maxAttempts = 2;
            let audioContext;
            let speechSynthesis = window.speechSynthesis;
            let isGameActive = false;
            let isSpeaking = false;

            // Initialize Audio Context on first user interaction
            function initAudio() {
                if (!audioContext) {
                    try {
                        audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        console.log('Audio context initialized');
                    } catch (e) {
                        console.warn('Web Audio API not supported:', e);
                    }
                }
            }

            // Enhanced Sound Effects
            function playBuzzer() {
                if (!audioContext) return;

                try {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();

                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);

                    oscillator.type = 'sawtooth';
                    oscillator.frequency.setValueAtTime(180, audioContext.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(100, audioContext.currentTime + 0.4);

                    gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                    gainNode.gain.linearRampToValueAtTime(0.2, audioContext.currentTime + 0.05);
                    gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.4);

                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.4);
                } catch (e) {
                    console.warn('Could not play buzzer sound:', e);
                }
            }

            function playGlitter() {
                if (!audioContext) return;

                try {
                    const frequencies = [523, 659, 784, 1047]; // C, E, G, C (major chord)

                    frequencies.forEach((freq, index) => {
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();

                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);

                        oscillator.type = 'sine';
                        oscillator.frequency.setValueAtTime(freq, audioContext.currentTime);

                        const startTime = audioContext.currentTime + index * 0.1;
                        gainNode.gain.setValueAtTime(0, startTime);
                        gainNode.gain.linearRampToValueAtTime(0.15, startTime + 0.05);
                        gainNode.gain.exponentialRampToValueAtTime(0.001, startTime + 0.15);

                        oscillator.start(startTime);
                        oscillator.stop(startTime + 0.15);
                    });
                } catch (e) {
                    console.warn('Could not play glitter sound:', e);
                }
            }

            // Enhanced Speech Synthesis
            function speakWord() {
                if (isSpeaking) {
                    speechSynthesis.cancel();
                    isSpeaking = false;
                    updateListenButton(false);
                    return;
                }

                const currentWord = currentQuestions[currentQuestionIndex];
                if (!currentWord) return;

                // Disable buttons during speech
                disableAnswerButtons(true);
                updateListenButton(true);
                isSpeaking = true;

                // Cancel any ongoing speech
                speechSynthesis.cancel();

                // Get segments and clean them
                const segments = currentWord.segments.split(' . . ').map((seg) => seg.trim());
                let segmentIndex = 0;

                function speakNextSegment() {
                    if (segmentIndex < segments.length && isSpeaking) {
                        const utterance = new SpeechSynthesisUtterance(segments[segmentIndex]);
                        utterance.lang = 'ar-SA';
                        utterance.rate = 0.6;
                        utterance.pitch = 1.1;
                        utterance.volume = 0.9;

                        utterance.onend = () => {
                            segmentIndex++;
                            if (segmentIndex < segments.length && isSpeaking) {
                                setTimeout(speakNextSegment, 400); // Pause between segments
                            } else {
                                // Speech finished
                                isSpeaking = false;
                                disableAnswerButtons(false);
                                updateListenButton(false);
                            }
                        };

                        utterance.onerror = () => {
                            console.warn('Speech synthesis error');
                            isSpeaking = false;
                            disableAnswerButtons(false);
                            updateListenButton(false);
                        };

                        speechSynthesis.speak(utterance);
                    } else {
                        isSpeaking = false;
                        disableAnswerButtons(false);
                        updateListenButton(false);
                    }
                }

                speakNextSegment();
            }

            function updateListenButton(isPlaying) {
                const btn = document.getElementById('listenBtn');
                if (isPlaying) {
                    btn.textContent = '⏹️ إيقاف';
                    btn.classList.add('pulse');
                } else {
                    btn.textContent = '🔊 أعد الاستماع';
                    btn.classList.remove('pulse');
                }
            }

            function disableAnswerButtons(disabled) {
                const buttons = document.querySelectorAll('.answer-btn');
                buttons.forEach((btn) => {
                    btn.disabled = disabled;
                    if (disabled) {
                        btn.style.opacity = '0.6';
                        btn.style.cursor = 'not-allowed';
                    } else {
                        btn.style.opacity = '1';
                        btn.style.cursor = 'pointer';
                    }
                });
            }

            // Game Logic
            function startLevel(level) {
                currentLevel = level;
                currentQuestionIndex = 0;
                score = 0;
                attempts = 0;
                isGameActive = true;

                // Initialize audio on user interaction
                initAudio();

                // Generate questions based on level
                let wordPool = [];
                if (level === 1) {
                    wordPool = [...LEVEL1];
                } else if (level === 2) {
                    wordPool = [...LEVEL2];
                } else {
                    wordPool = [...LEVEL1, ...LEVEL2];
                }

                // Shuffle and select 10 questions
                currentQuestions = shuffleArray(wordPool).slice(0, 10);

                // Show game area
                document.getElementById('levelSelection').classList.remove('active');
                document.getElementById('gameArea').classList.add('active');
                document.getElementById('resultsScreen').classList.remove('active');

                // Start first question
                showQuestion();
            }

            function shuffleArray(array) {
                const newArray = [...array];
                for (let i = newArray.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
                }
                return newArray;
            }

            function showQuestion() {
                if (currentQuestionIndex >= currentQuestions.length) {
                    showResults();
                    return;
                }

                const currentWord = currentQuestions[currentQuestionIndex];
                attempts = 0;

                // Update UI
                document.getElementById('wordEmoji').textContent = currentWord.emoji;
                document.getElementById('wordText').textContent = currentWord.word;
                document.getElementById('wordSegments').textContent = currentWord.segments;
                document.getElementById('wordSegments').classList.add('hidden');

                // Update progress
                updateProgress();

                // Clear feedback
                clearFeedback();

                // Reset button states
                disableAnswerButtons(false);
                updateListenButton(false);

                // Auto-speak the word after a short delay
                setTimeout(() => {
                    if (isGameActive) {
                        speakWord();
                    }
                }, 800);
            }

            function updateProgress() {
                const progress = (currentQuestionIndex / currentQuestions.length) * 100;
                document.getElementById('progressFill').style.width = progress + '%';
                document.getElementById('scoreDisplay').textContent = `السؤال: ${currentQuestionIndex + 1}/${currentQuestions.length} | النقاط: ${score}`;
            }

            function checkAnswer(selectedSyllables) {
                if (!isGameActive || isSpeaking) return;

                const currentWord = currentQuestions[currentQuestionIndex];
                const correctSyllables = currentWord.syllables;

                attempts++;

                // Stop any ongoing speech
                speechSynthesis.cancel();
                isSpeaking = false;
                updateListenButton(false);

                if (selectedSyllables === correctSyllables) {
                    // Correct answer
                    score++;
                    playGlitter();
                    showFeedback(`🎉 ممتاز! "${currentWord.word}" فيها ${correctSyllables} مقاطع`, 'correct');

                    // Add celebration animation
                    const wordText = document.getElementById('wordText');
                    wordText.classList.add('celebration', 'success-glow');

                    // Disable buttons during celebration
                    disableAnswerButtons(true);

                    // Auto-advance to next question
                    setTimeout(() => {
                        wordText.classList.remove('celebration', 'success-glow');
                        nextQuestion();
                    }, 1500);
                } else {
                    // Incorrect answer
                    playBuzzer();

                    if (attempts >= maxAttempts) {
                        // Show correct answer after max attempts
                        showFeedback(`الإجابة الصحيحة: "${currentWord.word}" فيها ${correctSyllables} مقاطع. ${currentWord.hint}`, 'incorrect');
                        document.getElementById('wordSegments').classList.remove('hidden');

                        // Disable buttons
                        disableAnswerButtons(true);

                        setTimeout(() => {
                            nextQuestion();
                        }, 3000);
                    } else {
                        // Give hint and allow retry
                        showFeedback(`حاول مرة أخرى! 💡 ${currentWord.hint}`, 'hint');

                        // Re-speak word slower after a delay
                        setTimeout(() => {
                            if (isGameActive) {
                                speakWord();
                            }
                        }, 1500);
                    }
                }
            }

            function showFeedback(message, type) {
                const feedbackElement = document.getElementById('feedbackMessage');
                feedbackElement.textContent = message;
                feedbackElement.className = 'feedback-message feedback-' + type;
                feedbackElement.classList.remove('hidden');

                // Announce to screen readers
                feedbackElement.setAttribute('aria-live', 'assertive');
            }

            function clearFeedback() {
                const feedbackElement = document.getElementById('feedbackMessage');
                feedbackElement.classList.add('hidden');
                feedbackElement.setAttribute('aria-live', 'polite');
                document.getElementById('hintText').classList.add('hidden');
            }

            function showHint() {
                const currentWord = currentQuestions[currentQuestionIndex];
                const hintElement = document.getElementById('hintText');
                hintElement.textContent = `💡 تلميح: ${currentWord.hint}`;
                hintElement.classList.remove('hidden');
            }

            function nextQuestion() {
                currentQuestionIndex++;
                showQuestion();
            }

            function showResults() {
                isGameActive = false;

                // Stop any ongoing speech
                speechSynthesis.cancel();
                isSpeaking = false;

                document.getElementById('gameArea').classList.remove('active');
                document.getElementById('resultsScreen').classList.add('active');

                const percentage = Math.round((score / currentQuestions.length) * 100);
                let message = `لقد أجبت على ${score} من ${currentQuestions.length} أسئلة بشكل صحيح\n`;
                message += `نسبة النجاح: ${percentage}%`;

                let emoji = '🎉';
                let encouragement = '';

                if (percentage >= 90) {
                    emoji = '🌟';
                    encouragement = 'ممتاز جداً! أنت بطل المقاطع!';
                } else if (percentage >= 80) {
                    emoji = '🎉';
                    encouragement = 'أحسنت جداً! أداء رائع!';
                } else if (percentage >= 60) {
                    emoji = '👍';
                    encouragement = 'أداء جيد! استمر في التدريب!';
                } else {
                    emoji = '💪';
                    encouragement = 'لا بأس، المحاولة القادمة ستكون أفضل!';
                }

                document.getElementById('resultsEmoji').textContent = emoji;
                document.getElementById('finalScore').innerHTML = `
                <div>${message}</div>
                <div style="margin-top: 15px; color: #5a67d8; font-weight: bold;">
                    ${encouragement}
                </div>
            `;
            }

            function restartGame() {
                startLevel(currentLevel);
            }

            function goToLevelSelection() {
                isGameActive = false;

                // Stop any ongoing speech
                speechSynthesis.cancel();
                isSpeaking = false;

                document.getElementById('gameArea').classList.remove('active');
                document.getElementById('resultsScreen').classList.remove('active');
                document.getElementById('levelSelection').classList.add('active');
            }

            // Enhanced Keyboard support with audio feedback
            document.addEventListener('keydown', function (e) {
                if (!isGameActive) return;

                if (document.getElementById('gameArea').classList.contains('active')) {
                    switch (e.key) {
                        case '2':
                            e.preventDefault();
                            // Add visual feedback
                            const btn2 = document.querySelector('[data-answer="2"]');
                            btn2.style.transform = 'scale(0.95)';
                            setTimeout(() => (btn2.style.transform = ''), 100);
                            checkAnswer(2);
                            break;
                        case '3':
                            e.preventDefault();
                            // Add visual feedback
                            const btn3 = document.querySelector('[data-answer="3"]');
                            btn3.style.transform = 'scale(0.95)';
                            setTimeout(() => (btn3.style.transform = ''), 100);
                            checkAnswer(3);
                            break;
                        case ' ':
                            e.preventDefault();
                            speakWord();
                            break;
                        case 'Enter':
                            e.preventDefault();
                            speakWord();
                            break;
                        case 'h':
                        case 'H':
                            e.preventDefault();
                            showHint();
                            break;
                        case 'Escape':
                            e.preventDefault();
                            goToLevelSelection();
                            break;
                    }
                }
            });

            // Add click sound for buttons
            document.addEventListener('click', function (e) {
                if (e.target.classList.contains('answer-btn') || e.target.classList.contains('control-btn') || e.target.classList.contains('level-btn')) {
                    // Ensure audio context is active
                    if (audioContext && audioContext.state === 'suspended') {
                        audioContext.resume();
                    }
                }
            });

            // Ensure proper cleanup when page unloads
            window.addEventListener('beforeunload', function () {
                isGameActive = false;
                speechSynthesis.cancel();
            });

            // Initialize the game when page loads
            window.addEventListener('load', function () {
                // Ensure speech synthesis is ready
                if (speechSynthesis.onvoiceschanged !== undefined) {
                    speechSynthesis.onvoiceschanged = function () {
                        console.log('Speech synthesis voices loaded');
                    };
                }

                // Focus management
                document.getElementById('levelSelection').setAttribute('tabindex', '-1');
                document.getElementById('levelSelection').focus();
            });

            // Handle visibility change (tab switching)
            document.addEventListener('visibilitychange', function () {
                if (document.hidden && isSpeaking) {
                    speechSynthesis.cancel();
                    isSpeaking = false;
                    updateListenButton(false);
                    disableAnswerButtons(false);
                }
            });

            // Touch device optimization
            if ('ontouchstart' in window) {
                document.body.style.cursor = 'pointer';
            }
        </script>
    </body>
</html>
